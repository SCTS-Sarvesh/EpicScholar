<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EpicScholar Dashboard | AI-Powered Study Platform</title>
    <style>
        /*
         * =================================================================
         * 1. CSS VARIABLES & BASE SETUP (001 - 100)
         * =================================================================
         */
        :root {
            --gradient: linear-gradient(135deg, #0072ff 0%, #ff416c 100%);
            --primary-color: #0072ff;
            --secondary-color: #ff416c;
            --info-color: #4CAF50;
            --warning-color: #FFC107;
            --edubot-color: #0072ff;

            /* Light Mode */
            --bg-light: #f5f7fa;
            --bg-light-tint: rgba(245, 247, 250, 0.98);
            --card-light: rgba(255, 255, 255, 0.65);
            --text-light: #2c3e50;
            --subtext-light: #5a6a7a;
            --shadow-light: 0 12px 35px rgba(31, 38, 135, 0.1);
            --border-light: 1px solid rgba(255, 255, 255, 0.2);

            /* Dark Mode (Default) */
            --bg-dark: #12121e;
            --bg-dark-tint: rgba(18, 18, 30, 0.98);
            --card-dark: rgba(22, 22, 30, 0.5);
            --text-dark: #e0e0e0;
            --subtext-dark: #b0b0b0;
            --shadow-dark: 0 12px 40px rgba(0, 0, 0, 0.6);
            --border-dark: 1px solid rgba(255, 255, 255, 0.05);

            /* UI Constants */
            --border-radius-xl: 20px;
            --transition-speed: 0.4s;
            --blur-level: 16px;
            --animation-timing: cubic-bezier(0.34, 1.56, 0.64, 1);
            --sidebar-width: 260px;

            /* Dark Theme */
            --bg-color: #0d0d0d;
            --text-color: #e9eef8;
            --primary-gradient: linear-gradient(135deg, #0072ff 0%, #ff416c 100%);
            --card-glass-bg: rgba(28, 28, 28, 0.4);
            --card-glass-border: rgba(255, 255, 255, 0.15);
            --secondary-glass: rgba(51, 51, 51, 0.6);
            --shadow-light: 0 0 10px rgba(0, 0, 0, 0.3), inset 0 0 5px rgba(255, 255, 255, 0.05);
            --shadow-deep: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --toast-bg: rgba(255, 255, 255, 0.15);
            --scroll-color: rgba(255, 255, 255, 0.2);
        }

        /* Base Body Styling */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-color: transparent;
            -webkit-transition: color var(--transition-speed);
            transition: color var(--transition-speed);
        }

        /* Animated Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -2;
            background: linear-gradient(-45deg, #0072ff, #ff416c, #333333, #111111);
            background-size: 400% 400%;
            -webkit-animation: liquid-gradient 25s ease infinite;
            animation: liquid-gradient 25s ease infinite;
        }

        /* Tint Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            -webkit-transition: background-color var(--transition-speed);
            transition: background-color var(--transition-speed);
            -webkit-mask-image: radial-gradient(ellipse 150% 150% at center, black 60%, transparent 100%);
            mask-image: radial-gradient(ellipse 150% 150% at center, black 60%, transparent 100%);
        }

        @-webkit-keyframes liquid-gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes liquid-gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .light-mode {
            color: var(--text-light);
        }

        .light-mode::after {
            background-color: var(--bg-light-tint);
        }

        .dark-mode {
            color: var(--text-dark);
        }

        .dark-mode::after {
            background-color: var(--bg-dark-tint);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .hiding {
            pointer-events: none;
        }

        /*
         * =================================================================
         * 2. LAYOUT & SIDEBAR (101 - 150)
         * =================================================================
         */

        #sidebar-placeholder {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 10px;
            z-index: 100;
            -webkit-backdrop-filter: blur(var(--blur-level));
            backdrop-filter: blur(var(--blur-level));
            -webkit-transition: all var(--transition-speed);
            transition: all var(--transition-speed);
            border-radius: 0 var(--border-radius-xl) var(--border-radius-xl) 0;
        }

        #self-study-main {
            margin-left: calc(var(--sidebar-width) + 30px);
            padding: 20px 50px;
            max-width: 1400px;
            transition: opacity 0.6s var(--animation-timing), transform 0.6s var(--animation-timing);
            overflow: auto;
        }

        #self-study-main.hiding {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        #controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /*
         * =================================================================
         * 3. BASE UI COMPONENTS (151 - 300)
         * =================================================================
         */

        .floating-card {
            border-radius: var(--border-radius-xl);
            padding: 25px;
            margin-bottom: 25px;
            box-sizing: border-box;
            -webkit-transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .glass-effect {
            -webkit-backdrop-filter: blur(var(--blur-level));
            backdrop-filter: blur(var(--blur-level));
        }

        .light-mode .glass-effect {
            background-color: var(--card-light);
            -webkit-box-shadow: var(--shadow-light);
            box-shadow: var(--shadow-light);
            border: var(--border-light);
        }

        .dark-mode .glass-effect {
            background-color: var(--card-dark);
            -webkit-box-shadow: var(--shadow-dark);
            box-shadow: var(--shadow-dark);
            border: var(--border-dark);
        }

        .floating-card:hover {
            -webkit-transform: translateY(-8px) scale(1.01);
            transform: translateY(-8px) scale(1.01);
            -webkit-box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .card-reveal {
            animation: card-load-in 0.6s var(--animation-timing) forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        @keyframes card-load-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-deleting {
            transition: opacity 0.3s, transform 0.3s;
        }


        .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            font-size: 1.8em;
            margin: 0 0 10px 0;
        }

        h2.gradient-text {
            font-size: 1.6em;
            margin-bottom: 0;
        }

        h3.gradient-text {
            font-size: 1.4em;
        }

        .action-btn,
        .gradient-button {
            padding: 12px 22px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: var(--gradient);
            color: white;
            font-weight: bold;
            font-size: 1em;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .action-btn:hover,
        .gradient-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 114, 255, 0.5);
        }

        .action-btn:active,
        .gradient-button:active,
        .card-action-btn:active {
            transform: translateY(0) scale(0.95) !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition-duration: 0.1s;
        }

        .secondary-button {
            background-color: transparent;
            border: 2px solid var(--subtext-dark);
            color: var(--subtext-dark);
            padding: 12px 22px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .light-mode .secondary-button {
            border-color: var(--subtext-light);
            color: var(--subtext-light);
        }

        .secondary-button:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            transform: translateY(-3px) scale(1.05);
        }

        /* Theme Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.4s;
            border-radius: 34px;
            border: var(--border-dark);
        }

        .toggle-slider:before {
            position: absolute;
            content: "üåô";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .light-mode .toggle-slider {
            background-color: #ccc;
            border: var(--border-light);
        }

        input:checked+.toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked+.toggle-slider:before {
            content: "‚òÄÔ∏è";
            transform: translateX(26px);
        }

        /*
         * =================================================================
         * 4. DASHBOARD GRID & SESSIONS (301 - 400)
         * =================================================================
         */

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        /* Subject Grid Styling */
        .subject-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .subject-score-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .light-mode .subject-score-box {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .subject-score-box:hover {
            transform: scale(1.05);
            background: var(--primary-color);
        }

        .subject-score-box .score {
            font-size: 1.8em;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .subject-score-box .subject-name {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--subtext-dark);
        }

        .light-mode .subject-score-box .subject-name {
            color: var(--subtext-light);
        }

        .subject-score-box:hover .subject-name {
            color: white !important;
        }

        .subject-score-box:hover .score {
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
            color: white;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #sessions-container {
            display: flex;
            overflow-x: auto;
            gap: 25px;
            padding-bottom: 20px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #sessions-container::-webkit-scrollbar {
            display: none;
        }

        .session-card {
            flex-shrink: 0;
            width: 340px;
            padding: 25px;
            padding-bottom: 70px;
            transition: all 0.3s, height 0s, margin 0s, padding 0s;
        }

        .session-card .session-duration {
            font-size: 0.9em;
            color: var(--info-color);
            font-weight: 600;
        }

        .card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .session-card:hover .card-actions {
            opacity: 1;
        }

        .card-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            color: var(--text-dark);
        }

        .light-mode .card-action-btn {
            color: var(--text-light);
            background: rgba(0, 0, 0, 0.1);
        }

        .card-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .session-card.ready-to-start {
            border-color: var(--secondary-color);
            box-shadow: 0 0 25px rgba(255, 65, 108, 0.6);
            animation: pulse-border 1.5s infinite alternate;
        }

        @keyframes pulse-border {
            from {
                opacity: 0.8;
            }

            to {
                opacity: 1;
            }
        }

        .timetable-container table {
            width: 100%;
            border-collapse: collapse;
        }

        .timetable-container th,
        .timetable-container td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode .timetable-container th,
        .light-mode .timetable-container td {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .resource-card {
            width: 300px;
            display: inline-block;
            margin-right: 20px;
        }

        .dashboard-grid .floating-card {
            min-height: 150px;
        }

        .dashboard-grid {
            margin-bottom: 40px;
        }

        /*
         * =================================================================
         * 5. MODALS & FORMS (401 - 550)
         * =================================================================
         */

        /* Base Modal (for Confirm, Session Form) */
        .modal {
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal.hiding {
            animation: fadeOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .modal-content {
            width: 450px;
            padding: 30px 35px;
            text-align: center;
            position: relative;
            animation: water-drop-in 0.6s var(--animation-timing) forwards;
            background: var(--card-dark);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 2px solid var(--card-glass-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border-radius: var(--border-radius-xl);
        }

        .light-mode .modal-content {
            background: var(--card-light);
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: var(--shadow-light);
        }

        .modal-close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--secondary-color);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 3001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-close-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        @keyframes water-drop-in {
            0% {
                transform: scale(0.5) translateY(-100px);
                opacity: 0;
            }

            80% {
                transform: scale(1.05) translateY(10px);
                opacity: 1;
            }

            100% {
                transform: scale(1) translateY(0);
            }
        }

        /* Marks Modal Popup - Enhanced Styling */
        #marks-modal {
            position: fixed;
            z-index: 3001;
            width: 500px;
            height: 500px;
            overflow-y: auto;

            /* Start hidden and small */
            opacity: 0;
            transform: scale(0.5);
            transform-origin: center;
            transition: all 0.5s var(--animation-timing);
            pointer-events: none;

            /* Enhanced glass effect */
            background: var(--card-dark);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid var(--card-glass-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border-radius: var(--border-radius-xl);
        }

        .light-mode #marks-modal {
            background: var(--card-light);
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: var(--shadow-light);
        }

        #marks-modal.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            top: 50% !important;
            left: 50% !important;
            pointer-events: auto;
        }

        #marks-modal-content {
            text-align: left;
            margin-top: 15px;
        }

        .mark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .light-mode .mark-item {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mark-item:hover {
            background: rgba(0, 114, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .mark-item .mark-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .light-mode .mark-item .mark-name {
            color: var(--text-light);
        }

        .mark-item .mark-score {
            font-weight: 700;
            font-size: 1.2em;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        #marks-modal h3 {
            margin-top: 0;
        }


        /* Session Form Styling */
        #session-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--subtext-dark);
            font-size: 0.9em;
        }

        .light-mode .form-group label {
            color: var(--subtext-light);
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-dark);
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .light-mode .form-group input,
        .light-mode .form-group select {
            border-color: rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.5);
            color: var(--text-light);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        #session-form .gradient-button {
            margin-top: 15px;
        }

        /* Video Player Modal Specifics */
        #video-player-modal .modal-content {
            width: 90%;
            max-width: 1000px;
            padding: 0;
            background: none;
            box-shadow: none;
            border: none;
            text-align: left;
            overflow: visible;
        }

        #video-player-modal .modal-close-btn {
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
            font-size: 24px;
        }

        #video-player-modal .video-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-dark);
        }

        #video-player-modal .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        #video-player-modal #video-title {
            padding: 0 10px 10px 10px;
            margin: 0;
        }

        /*
         * =================================================================
         * 5B. AI SESSION LAYOUT (550 - 650)
         * =================================================================
         */

        /* AI Session Container Layout */
        .ai-session-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            height: 100%;
            animation: slideInFromBottom 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            margin-top: 20px;
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .session-main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        /* Right Sidebar for Concepts and Progress */
        .session-sidebar {
            background: var(--card-dark);
            backdrop-filter: blur(var(--blur-level));
            border: var(--border-dark);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .light-mode .session-sidebar {
            background: var(--card-light);
            border: var(--border-light);
        }

        /* Concepts List */
        .concepts-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .concept-item {
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-bottom: 10px;
            opacity: 0;
            animation: fadeInUp 0.4s ease forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .concept-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .concept-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .concept-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .concept-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .concept-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .light-mode .concept-item {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .concept-item:hover {
            background: rgba(0, 114, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .concept-item.active {
            background: var(--primary-gradient);
            border-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .concept-item.completed {
            opacity: 0.7;
            border-color: var(--info-color);
        }

        .concept-item.completed::before {
            content: '‚úì';
            color: var(--info-color);
            font-weight: bold;
        }

        .concept-item.active::before {
            content: '‚ñ∂';
            color: white;
        }

        /* Circular Progress in Sidebar */
        .progress-circle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .circular-progress {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .circular-progress .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
        }

        .circular-progress .progress-label {
            font-size: 0.5em;
            display: block;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Floating Action Buttons (Bottom Bar) */
        .session-bottom-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .floating-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 114, 255, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-action-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 35px rgba(0, 114, 255, 0.6);
        }

        .floating-action-btn.pdf-btn {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
        }

        .floating-action-btn.pdf-btn:hover {
            box-shadow: 0 12px 35px rgba(255, 193, 7, 0.6);
        }

        /* Enhanced Quiz Container for AI Sessions */
        .ai-quiz-container {
            background: var(--card-dark);
            backdrop-filter: blur(var(--blur-level));
            border: var(--border-dark);
            border-radius: var(--border-radius-xl);
            padding: 30px;
            margin-top: 20px;
            animation: slideInUp 0.5s ease-out;
        }

        .light-mode .ai-quiz-container {
            background: var(--card-light);
            border: var(--border-light);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .quiz-question {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .light-mode .quiz-option {
            background: rgba(0, 0, 0, 0.03);
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .quiz-option:hover {
            background: rgba(0, 114, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .quiz-option.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .quiz-option.correct {
            background: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }

        .quiz-option.incorrect {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }

        .quiz-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .quiz-feedback.correct {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--info-color);
            color: var(--info-color);
        }

        .quiz-feedback.incorrect {
            background: rgba(255, 65, 108, 0.2);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        /* Video Player in AI Session */
        .ai-video-container {
            background: var(--card-dark);
            backdrop-filter: blur(var(--blur-level));
            border: var(--border-dark);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            overflow: hidden;
        }

        .light-mode .ai-video-container {
            background: var(--card-light);
            border: var(--border-light);
        }

        .ai-video-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 */
            border-radius: 12px;
            overflow: hidden;
        }

        .ai-video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /*
         * =================================================================
         * 6. LIVE SESSION PAGE & YOUTUBE SECTION (551 - 700)
         * =================================================================
         */

        #live-session-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;

            opacity: 0;
            transform: scale(1.1);
            transition: all 0.6s var(--animation-timing);

            background-color: var(--bg-dark-tint);
        }

        .light-mode #live-session-page {
            background-color: var(--bg-light-tint);
        }

        #live-session-page.open {
            opacity: 1;
            transform: scale(1);
        }

        #live-session-page.hiding {
            opacity: 0;
            transform: scale(0.9);
        }

        .live-session-header-bar {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto 20px auto;
            padding: 15px 30px;
            border-radius: var(--border-radius-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: var(--border-dark);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .light-mode .live-session-header-bar {
            border: var(--border-light);
            box-shadow: var(--shadow-light);
        }

        .live-session-header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #live-session-timer {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-dark);
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 10px;
            border: var(--border-dark);
            min-width: 50px;
            text-align: center;
        }

        .light-mode #live-session-timer {
            color: var(--text-light);
            background: rgba(0, 0, 0, 0.05);
            border: var(--border-light);
        }

        /* Session Control Buttons */
        #pause-session-btn,
        #live-take-test-btn {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        #end-session-btn {
            padding: 10px 20px;
            font-size: 0.9em;
            background: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
        }

        #end-session-btn:hover {
            background: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.5);
        }


        .live-session-content-area {
            flex-grow: 1;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 100px;
            transition: filter 0.5s var(--animation-timing);
            position: relative;
        }

        .live-session-content-area::-webkit-scrollbar {
            display: none;
        }

        /* YouTube Search Styling */
        .search-bar-live {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 15px;
            padding: 20px;
            border-radius: var(--border-radius-xl);
        }

        .search-bar-live input {
            flex-grow: 1;
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-dark);
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .light-mode .search-bar-live input {
            border-color: rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.5);
            color: var(--text-light);
        }

        .search-bar-live input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-bar-live input:disabled {
            background: rgba(0, 0, 0, 0.1);
            color: var(--subtext-dark);
            cursor: not-allowed;
        }

        .light-mode .search-bar-live input:disabled {
            background: rgba(0, 0, 0, 0.05);
            color: var(--subtext-light);
        }

        .videos-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
            padding-top: 10px;
        }

        .youvideo {
            width: calc(25% - 15px);
            max-width: 300px;
            display: block;
            text-decoration: none;
            border: none;
            border-radius: 12px;
            padding: 15px;
            background: var(--card-dark);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            position: relative;
        }

        .light-mode .youvideo {
            background: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        .youvideo:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .youvideo .thumbnail-container {
            position: relative;
            width: 100%;
        }

        .youvideo img {
            width: 100%;
            border-radius: 8px;
            aspect-ratio: 16 / 9;
            display: block;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            backdrop-filter: blur(2px);
        }

        .youvideo h3 {
            font-size: 16px;
            margin: 10px 0 5px 0;
            color: var(--text-dark);
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .light-mode .youvideo h3 {
            color: var(--text-light);
        }

        .youvideo p {
            font-size: 0.9em;
            color: var(--subtext-dark);
            margin: 0;
        }

        .light-mode .youvideo p {
            color: var(--subtext-light);
        }

        .loader {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 50px;
            width: 100%;
        }

        .theme-loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .light-mode .theme-loader {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }


        /*
         * =================================================================
         * 7. FLOATING CHATBOT & ICONS (701 - 850)
         * =================================================================
         */

        /* Floating Icon Base (for bot and PDF) */
        .floating-action-icon {
            position: fixed;
            right: 30px;
            width: 60px;
            height: 60px;
            color: white;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            z-index: 2000;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s var(--animation-timing);
        }

        .floating-action-icon.visible {
            transform: scale(1);
            opacity: 1;
        }

        #pdf-icon {
            bottom: 100px;
            background: var(--warning-color);
        }

        #pdf-icon:hover {
            background: #ffdb58;
        }

        #chatbot-icon {
            bottom: 30px;
            background: var(--edubot-color);
        }

        #chatbot-icon:hover {
            background: var(--secondary-color);
        }

        /* Floating Window Base (for Chat and PDF) */
        .floating-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 450px;
            border-radius: var(--border-radius-xl);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
            transform: translateY(50px) scale(0.9);
            opacity: 0;
            transition: all 0.4s var(--animation-timing);
            pointer-events: none;

            backdrop-filter: blur(var(--blur-level));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode .floating-window {
            border: var(--border-light);
            box-shadow: var(--shadow-light);
        }

        .floating-window.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        /* Chatbot Container */
        #chatbot-container {
            background-color: rgba(31, 31, 31, 0.95);
        }

        .light-mode #chatbot-container {
            background-color: var(--card-light);
        }

        #chatbot-header {
            background-color: var(--edubot-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        #chatbot-header #close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }

        #chatbot-header #close-btn:hover {
            transform: rotate(90deg);
        }

        #chatbot-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
        }

        #chatbot-messages {
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user {
            background-color: var(--edubot-color);
            color: white;
            align-self: flex-end;
        }

        .message.bot {
            background-color: #333;
            color: white;
            align-self: flex-start;
        }

        .light-mode .message.bot {
            background-color: #eee;
            color: var(--text-light);
        }

        #chatbot-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: #2c2c2c;
        }

        .light-mode #chatbot-input-container {
            background-color: #f0f0f0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        #chatbot-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 10px;
            background-color: #333;
            color: white;
        }

        .light-mode #chatbot-input {
            background-color: #fff;
            color: var(--text-light);
            border-color: #ccc;
        }

        #send-btn {
            margin-left: 10px;
            padding: 10px 15px;
            background-color: var(--edubot-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        #send-btn:hover {
            background-color: var(--secondary-color);
        }

        #send-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        /* PDF Viewer Container */
        #pdf-container {
            background-color: rgba(40, 40, 40, 0.95);
        }

        .light-mode #pdf-container {
            background-color: var(--card-light);
        }

        #pdf-header {
            background-color: var(--warning-color);
            color: #333;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }

        #pdf-header #pdf-close-btn {
            background: none;
            border: none;
            color: #333;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }

        #pdf-header #pdf-close-btn:hover {
            transform: rotate(90deg);
        }

        #pdf-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pdf-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-dark);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .light-mode .pdf-item {
            background: rgba(0, 0, 0, 0.05);
            border-color: var(--border-light);
        }

        .pdf-item:hover {
            background: var(--warning-color);
            color: #333;
            border-color: var(--warning-color);
        }

        .pdf-item h4 {
            margin: 0 0 5px 0;
            font-size: 1em;
        }

        .pdf-item p {
            margin: 0;
            font-size: 0.85em;
            color: var(--subtext-dark);
        }

        .light-mode .pdf-item p {
            color: var(--subtext-light);
        }

        .pdf-item:hover p {
            color: #333;
        }


        /*
         * =================================================================
         * 8. SIDEBAR STYLING (851 - 950)
         * =================================================================
         */

        .sidebar {
            width: 260px;
            top: 15px;
            left: 0px;
            padding: 20px 0;
            z-index: 500;
            position: relative;
            height: 90vh;
        }

        .nav-wrap {
            padding: 10px 0;
            position: relative;
        }

        .nav-item {
            padding: 15px 20px 15px 30px;
            margin: 8px 10px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            cursor: pointer;
            border-radius: 12px;
        }

        .nav-item.active,
        .nav-item:hover {
            background-color: var(--secondary-glass);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-item.active {
            color: var(--secondary-color);
            font-weight: 700;
        }

        .settings-wrap {
            position: absolute;
            bottom: 50px;
            width: 100%;
            text-align: left;
        }

        /* Entry Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .sidebar {
            animation: slideInLeft 0.7s 0.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }

        .nav-wrap {
            position: relative;
            bottom: 50px;
        }

        .nav-item {
            padding: 15px 20px 15px 30px;
            margin: 8px 10px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            cursor: pointer;
            border-radius: 12px;
        }

        .nav-item.active {
            color: var(--secondary-color);
            font-weight: 700;
        }

        .nav-wrap {
            padding: 10px 0;
            position: relative;
        }

        .settings-wrap {
            position: absolute;
            bottom: 75px;
            width: 100%;
            text-align: left;
        }

        .nav-item {
            padding: 15px 20px 15px 30px;
            margin: 8px 10px;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            top: 50px;
            cursor: pointer;
            border-radius: 12px;
            display: block;
            text-decoration: none;
        }

        .nav-item:hover {
            background-color: var(--secondary-glass);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-item-active {
            background-color: var(--secondary-glass);
            color: #ff416c;
            font-weight: 700;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 15px 20px 15px 30px;
            margin: 8px 10px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            top: 50px;
            cursor: pointer;
            border-radius: 12px;
            display: block;
            text-decoration: none;
        }

        /*
         * =================================================================
         * 9. CIRCULAR PROGRESS (951 - 1050)
         * =================================================================
         */

        /* Circular Progress Performance Box */
        #overall-performance-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
        }

        .circular-progress-container {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .circular-progress {
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 12;
        }

        .light-mode .progress-circle-bg {
            stroke: rgba(0, 0, 0, 0.1);
        }

        .progress-circle {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-in-out, stroke 0.5s ease;
            animation: progressAnimation 2s ease-out forwards;
        }

        @keyframes progressAnimation {
            from {
                stroke-dashoffset: 502;
            }
        }

        /* Color based on percentage */
        .progress-circle.excellent {
            stroke: url(#gradient-excellent);
        }

        .progress-circle.good {
            stroke: url(#gradient-good);
        }

        .progress-circle.average {
            stroke: url(#gradient-average);
        }

        .progress-circle.poor {
            stroke: url(#gradient-poor);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #0072ff 0%, #ff416c 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            line-height: 1;
            display: block;
        }

        .progress-label {
            font-size: 0.85em;
            color: var(--subtext-dark);
            margin-top: 5px;
            font-weight: 600;
        }

        .light-mode .progress-label {
            color: var(--subtext-light);
        }

        #overall-performance-box>p {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .light-mode #overall-performance-box>p {
            color: var(--text-light);
        }

        /*
         * =================================================================
         * 10. MEDIA QUERIES (1051 - END)
         * =================================================================
         */

        @media (max-width: 1200px) {
            #self-study-main {
                margin-left: calc(var(--sidebar-width) + 10px);
                padding: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }

            .youvideo {
                width: calc(33.33% - 14px);
            }

            .floating-window {
                transform: scale(0.9);
            }

            .floating-action-icon {
                transform: scale(0.9);
            }
        }

        @media (max-width: 900px) {
            .subject-grid {
                grid-template-columns: 1fr 1fr;
            }

            .live-session-header-bar h1 {
                font-size: 1.5em;
            }
        }

        @media (max-width: 768px) {
            #sidebar-placeholder {
                left: -300px;
            }

            #self-study-main {
                margin-left: 20px;
                max-width: 100%;
                padding: 10px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .youvideo {
                width: calc(50% - 10px);
            }

            .floating-window {
                right: 10px;
                bottom: 80px;
                width: 90%;
                height: 350px;
            }

            .floating-action-icon {
                right: 10px;
            }

            #pdf-icon {
                bottom: 80px;
            }

            #chatbot-icon {
                bottom: 10px;
            }

            #video-player-modal .modal-content {
                width: 95%;
            }

            #video-player-modal .modal-close-btn {
                top: -10px;
                right: -10px;
                width: 35px;
                height: 35px;
            }

            #controls {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .live-session-header-bar {
                flex-direction: column;
                gap: 10px;
            }

            .live-session-header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .circular-progress-container {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            .youvideo {
                width: 100%;
            }

            .subject-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Liquid Glass Background */
        #liquid-glass-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            overflow: hidden;
        }

        .glass-blob {
            position: absolute;
            width: 600px;
            height: 600px;
            background: var(--primary-gradient);
            border-radius: 50%;
            opacity: 0.18;
            filter: blur(150px);
            animation: moveBlob 30s infinite alternate;
        }

        .blob-1 {
            top: -20%;
            left: -20%;
            animation-duration: 34s;
        }

        .blob-2 {
            bottom: -25%;
            right: -25%;
            background: var(--secondary-color);
            opacity: 0.12;
            filter: blur(120px);
            animation-duration: 28s;
        }

        .blob-3 {
            top: 60%;
            left: 40%;
            width: 400px;
            height: 400px;
            opacity: 0.25;
            animation-duration: 32s;
        }

        @keyframes moveBlob {
            0% {
                transform: translate(0, 0) scale(1.0);
                filter: hue-rotate(0deg) blur(150px);
            }

            50% {
                transform: translate(150px, -100px) scale(1.1);
                filter: hue-rotate(10deg) blur(180px);
            }

            100% {
                transform: translate(-80px, 80px) scale(0.9);
                filter: hue-rotate(0deg) blur(150px);
            }
        }

        .glass-element {
            background: var(--card-glass-bg);
            border: 1px solid var(--card-glass-border);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            box-shadow: var(--shadow-deep);
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Marks Modal Popup - Enhanced Styling */
        .marks-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3001;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .marks-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .marks-modal-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;

            /* Start hidden and small */
            transform: scale(0.5);
            transition: transform 0.5s var(--animation-timing);

            /* Enhanced glass effect */
            background: var(--card-dark);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid var(--card-glass-border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border-radius: var(--border-radius-xl);
            position: absolute;
            top: 0;
        }

        .marks-modal-overlay.visible .marks-modal-content {
            transform: scale(1);
        }

        .light-mode .marks-modal-content {
            background: var(--card-light);
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: var(--shadow-light);
        }

        #marks-modal-content {
            text-align: left;
            margin-top: 15px;
        }

        .mark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .light-mode .mark-item {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mark-item:hover {
            background: rgba(0, 114, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .mark-item .mark-name {
            font-weight: 500;
            color: var(--text-dark);
        }

        .light-mode .mark-item .mark-name {
            color: var(--text-light);
        }

        .mark-item .mark-score {
            font-weight: 700;
            font-size: 1.2em;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        #marks-modal-content h3 {
            margin-top: 0;
        }

        /* Enhanced Marks Modal Animation - Appears from clicked box */
        .marks-modal-overlay.closing .marks-modal-content {
            transform: scale(0);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045), opacity 0.3s ease;
        }

        /* Quiz Modal Specific Styles - Add to your <style> section */

        /* Quiz Navigation Dots */
        .quiz-nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .light-mode .quiz-nav-dot {
            background: rgba(0, 0, 0, 0.2);
        }

        .quiz-nav-dot.active {
            background: linear-gradient(135deg, #0072ff 0%, #ff416c 100%);
            transform: scale(1.5);
        }

        .quiz-nav-dot.answered {
            background: rgba(0, 114, 255, 0.5);
        }

        /* Quiz Questions */
        .quiz-question-card {
            position: absolute;
            width: 90%;
            padding: 2rem;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            transform: translateX(100%);
            background-color: var(--card-dark);
        }

        .light-mode .quiz-question-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .quiz-question-card.active {
            opacity: 1;
            transform: translateX(0);
            position: relative;
        }

        .quiz-question-card.prev {
            transform: translateX(-100%);
        }

        .quiz-question-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            line-height: 1.6;
            color: var(--text-dark);
        }

        .light-mode .quiz-question-title {
            color: var(--text-light);
        }

        .quiz-option-btn {
            width: 100%;
            text-align: left;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            color: var(--text-dark);
            position: relative;
            overflow: hidden;
        }

        .light-mode .quiz-option-btn {
            background: rgba(0, 0, 0, 0.03);
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .quiz-option-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 114, 255, 0.2) 0%, rgba(255, 65, 108, 0.2) 100%);
            transition: width 0.4s;
            z-index: -1;
        }

        .quiz-option-btn:hover:not(:disabled) {
            transform: translateX(10px);
            border-color: #0072ff;
        }

        .quiz-option-btn:hover::before {
            width: 100%;
        }

        .quiz-option-btn.selected {
            background: linear-gradient(135deg, rgba(0, 114, 255, 0.3) 0%, rgba(255, 65, 108, 0.3) 100%);
            border-color: #0072ff;
            transform: scale(1.02);
        }

        .quiz-option-btn.correct {
            background: rgba(16, 185, 129, 0.3);
            border-color: #10b981;
        }

        .quiz-option-btn.incorrect {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }

        /* Quiz Results */
        .quiz-results-container {
            text-align: center;
            animation: scaleIn 0.6s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .quiz-score-circle {
            width: 200px;
            height: 200px;
            margin: 2rem auto;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0072ff 0%, #ff416c 100%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .quiz-score-number {
            font-size: 4rem;
            font-weight: 800;
            color: white;
        }

        .quiz-score-label {
            font-size: 1.2rem;
            opacity: 0.9;
            color: white;
        }

        .quiz-commentary {
            font-size: 1.5rem;
            margin: 2rem 0;
            font-weight: 600;
        }

        .quiz-commentary-detail {
            font-size: 1.1rem;
            color: var(--subtext-dark);
            margin-bottom: 2rem;
        }

        .light-mode .quiz-commentary-detail {
            color: var(--subtext-light);
        }

        /* Quiz Review Section */
        .quiz-review-container {
            width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 114, 255, 0.3) transparent;
            margin-bottom: 2rem;
        }

        .quiz-review-card {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .light-mode .quiz-review-card {
            background: rgba(255, 255, 255, 0.8);
        }

        .quiz-review-card.correct {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .quiz-review-card.incorrect {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .quiz-review-card:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 30px rgba(0, 114, 255, 0.2);
        }

        .quiz-review-question-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .quiz-review-status-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .quiz-review-status-badge.correct {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
            border: 2px solid #10b981;
        }

        .quiz-review-status-badge.incorrect {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        .quiz-review-question-text {
            font-weight: 600;
            font-size: 1.1rem;
            flex-grow: 1;
            color: var(--text-dark);
        }

        .light-mode .quiz-review-question-text {
            color: var(--text-light);
        }

        .quiz-review-options {
            margin: 1rem 0;
        }

        .quiz-review-option {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.75rem;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .light-mode .quiz-review-option {
            background: rgba(0, 0, 0, 0.03);
            color: var(--text-light);
        }

        .quiz-review-option.correct {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }

        .quiz-review-option.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .quiz-review-option.user-wrong {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        .quiz-review-option-label {
            font-weight: 700;
            min-width: 30px;
        }

        .quiz-option-indicator {
            margin-left: auto;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .quiz-review-explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 114, 255, 0.1);
            border-radius: 0.75rem;
            border-left: 4px solid #0072ff;
        }

        .quiz-explanation-title {
            color: #0072ff;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quiz-explanation-text {
            color: var(--subtext-dark);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .light-mode .quiz-explanation-text {
            color: var(--subtext-light);
        }

        /* ========================================
   CHATBOT ENHANCED STYLES - Markdown & Formatting
   ======================================== */

        /* Markdown Table Styling */
        .markdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .markdown-table th {
            background: rgba(0, 114, 255, 0.2);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .light-mode .markdown-table {
            background: rgba(0, 0, 0, 0.02);
        }

        .light-mode .markdown-table th {
            background: rgba(0, 114, 255, 0.1);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .light-mode .markdown-table td {
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        /* Code Block Styling */
        .code-block {
            background: rgba(0, 0, 0, 0.45) !important;
            padding: 12px !important;
            border-radius: 8px !important;
            overflow-x: auto !important;
            margin: 10px 0 !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode .code-block {
            background: rgba(0, 0, 0, 0.05) !important;
            border-color: rgba(0, 0, 0, 0.1);
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e0e0e0;
        }

        .light-mode .code-block code {
            color: #2c3e50;
        }

        /* Inline Code */
        code {
            background: rgba(255, 255, 255, 0.06);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        .light-mode code {
            background: rgba(0, 0, 0, 0.06);
        }

        /* Markdown Headings in Messages */
        .message-text h1,
        .message-text h2,
        .message-text h3,
        .message-text h4,
        .message-text h5,
        .message-text h6 {
            margin: 15px 0 10px 0;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .message-text h1 {
            font-size: 1.8em;
        }

        .message-text h2 {
            font-size: 1.5em;
        }

        .message-text h3 {
            font-size: 1.3em;
        }

        .message-text h4 {
            font-size: 1.1em;
        }

        .message-text h5 {
            font-size: 1em;
        }

        .message-text h6 {
            font-size: 0.9em;
        }

        /* Lists in Messages */
        .message-text ul,
        .message-text ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message-text li {
            margin: 5px 0;
            line-height: 1.6;
        }

        /* Links in Messages */
        .message-text a {
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 1px solid var(--primary-color);
            transition: all 0.3s;
        }

        .message-text a:hover {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        /* Typing Indicator Animation */
        .typing-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
        }

        .typing-container .dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }

        .typing-container .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-container .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing-bounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .typing-container span {
            color: var(--subtext-dark);
            font-style: italic;
        }

        .light-mode .typing-container span {
            color: var(--subtext-light);
        }

        /* Streaming Cursor */
        .cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--primary-color);
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            49% {
                opacity: 1;
            }

            50%,
            100% {
                opacity: 0;
            }
        }

        /* Message Actions Bar */
        .message .actions-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .light-mode .message .actions-bar {
            border-top-color: rgba(0, 0, 0, 0.05);
        }

        .message:hover .actions-bar {
            opacity: 1;
        }

        .message .timestamp-text {
            font-size: 0.75em;
            color: var(--subtext-dark);
            margin-right: auto;
        }

        .light-mode .message .timestamp-text {
            color: var(--subtext-light);
        }

        .message .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            color: var(--text-dark);
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .light-mode .message .action-btn {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-light);
        }

        .message .action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .message .action-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        /* TTS Word Highlighting */
        .message.reading-active {
            box-shadow: 0 0 20px rgba(0, 114, 255, 0.5);
            border-color: var(--primary-color);
        }

        .highlight-word {
            background: rgba(0, 114, 255, 0.3);
            padding: 2px 4px;
            border-radius: 4px;
            animation: highlight-pulse 0.5s ease-in-out;
        }

        @keyframes highlight-pulse {

            0%,
            100% {
                background: rgba(0, 114, 255, 0.3);
            }

            50% {
                background: rgba(0, 114, 255, 0.5);
            }
        }

        /* Message Images */
        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .message-images .inline-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .light-mode .message-images .inline-image {
            border-color: rgba(0, 0, 0, 0.1);
        }

        .message-images .inline-image:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--card-dark);
            backdrop-filter: blur(var(--blur-level));
            border: var(--border-dark);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-dark);
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s var(--animation-timing);
        }

        .light-mode .toast {
            background: var(--card-light);
            border: var(--border-light);
            box-shadow: var(--shadow-light);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast i {
            font-size: 1.2em;
            color: var(--info-color);
        }

        .toast .fa-circle-xmark {
            color: var(--secondary-color);
        }

        .toast span {
            color: var(--text-dark);
            font-weight: 500;
        }

        .light-mode .toast span {
            color: var(--text-light);
        }
    </style>
</head>

<body class="dark-mode">
    <div id="sidebar-placeholder">
        <div class="sidebar glass-element fixed-top-layer">
            <div class="nav-wrap" id="navWrap">
                <a class="nav-item" href="home.html" data-icon="üè†">üè† Home </a>
                <a class="nav-item" href="messages.html" data-icon="‚úâÔ∏è">‚úâÔ∏è Messages</a>
                <a class="nav-item-active" href="self-study.html" data-icon="üìñ">üìñ Self-Study</a>
                <a class="nav-item" href="edubot.html" data-icon="ü§ñ">ü§ñ EduBot</a>
                <a class="nav-item" href="mini-games.html" data-icon="üéÆ">üéÆ Mini-Games</a>
            </div>

            <div class="settings-wrap">
                <a class="nav-item" href="profile.html" data-icon="üë§">üë§ Profile</a>
            </div>
        </div>
    </div>

    <main id="self-study-main">
        <header>
            <h1 class="gradient-text">EpicScholar Dashboard</h1>
            <div id="controls">
                <label class="toggle-switch">
                    <input type="checkbox" id="mode-toggle-checkbox">
                    <span class="toggle-slider"></span>
                </label>
                <button id="add-session-btn" class="action-btn">üìÖ Add Session</button>
                <button id="add-test-btn" class="action-btn">üìù Add Test</button>
            </div>
        </header>

        <section id="performance-dashboard">
            <h2 class="gradient-text">üìä Performance Dashboard</h2>
            <div class="dashboard-grid">
                <div id="overall-performance-box" class="floating-card glass-effect">
                    <div class="circular-progress-container">
                        <svg class="circular-progress" width="180" height="180">
                            <defs>
                                <linearGradient id="gradient-excellent" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#8BC34A;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="gradient-good" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0072ff;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="gradient-average" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#FFC107;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#FF9800;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="gradient-poor" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ff416c;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#FF5252;stop-opacity:1" />
                                </linearGradient>
                            </defs>

                            <circle class="progress-circle-bg" cx="90" cy="90" r="80"></circle>

                            <circle class="progress-circle excellent" cx="90" cy="90" r="80" id="progress-circle"
                                stroke-dasharray="502" stroke-dashoffset="502">
                            </circle>
                        </svg>

                        <div class="progress-text">
                            <span class="progress-percentage" id="overall-percentage">88.5%</span>
                            <span class="progress-label">Overall</span>
                        </div>
                    </div>
                    <p>Overall Average Score</p>
                </div>

                <div id="subject-breakdown-box" class="floating-card glass-effect">
                    <h3 class="gradient-text">Subject Breakdown</h3>
                    <div class="subject-grid" id="subject-grid-container">
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="Math">
                            <span class="score gradient-text">92%</span>
                            <span class="subject-name">Math</span>
                        </div>
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="Science">
                            <span class="score gradient-text">85%</span>
                            <span class="subject-name">Science</span>
                        </div>
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="History">
                            <span class="score gradient-text">90%</span>
                            <span class="subject-name">History</span>
                        </div>
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="Physics">
                            <span class="score gradient-text">88%</span>
                            <span class="subject-name">Physics</span>
                        </div>
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="English">
                            <span class="score gradient-text">95%</span>
                            <span class="subject-name">English</span>
                        </div>
                        <div class="subject-score-box" data-action="toggle-marks" data-subject="Chemistry">
                            <span class="score gradient-text">83%</span>
                            <span class="subject-name">Chemistry</span>
                        </div>
                    </div>
                </div>

                <div class="floating-card glass-effect">
                    <h3 class="gradient-text">Weekly Study Time</h3>
                    <p style="font-size: 2.5em; font-weight: 700;">14h 30m</p>
                    <p style="font-size: 0.9em; color: var(--info-color);">+1.5h from last week</p>
                </div>
            </div>
        </section>

        <hr style="border-color: rgba(255,255,255,0.1);">

        <section id="sessions-tests">
            <div class="section-header">
                <h2 class="gradient-text">‚è≥ Upcoming Sessions & Tests</h2>
            </div>
            <div id="sessions-container">
            </div>
        </section>

        <hr style="border-color: rgba(255,255,255,0.1);">

        <section id="exam-timetable">
            <div class="section-header">
                <h2 class="gradient-text">üóìÔ∏è Exam Timetable</h2>
            </div>
            <div class="floating-card glass-effect timetable-container">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Subject</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="timetable-body"></tbody>
                </table>
            </div>
        </section>

        <hr style="border-color: rgba(255,255,255,0.1);">

        <section id="resources">
            <div class="section-header">
                <h2 class="gradient-text">üìö Shared Resources</h2>
            </div>
            <div id="resources-container">
            </div>
        </section>
    </main>

    <!-- Session Form Modal -->
    <div id="session-form-modal" class="modal hidden">
        <div class="modal-content floating-card glass-effect">
            <button class="modal-close-btn" data-modal-id="session-form-modal">&times;</button>
            <h3 id="session-form-title" class="gradient-text">Add New Session</h3>
            <form id="session-form">
                <div class="form-group">
                    <label for="session-title">Topic Name</label>
                    <input type="text" id="session-title" name="title" required
                        placeholder="e.g., The French Revolution">
                </div>
                <div class="form-group">
                    <label for="session-subject">Subject</label>
                    <input type="text" id="session-subject" name="subject" required placeholder="e.g., History">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="session-date">Date</label>
                        <input type="date" id="session-date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="session-time">Time</label>
                        <input type="time" id="session-time" name="time" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="session-duration">Duration</label>
                    <select id="session-duration" name="duration" required>
                        <option value="30">30 Minutes</option>
                        <option value="45">45 Minutes</option>
                        <option value="60" selected>1 Hour</option>
                        <option value="90">1 Hour 30 Minutes</option>
                        <option value="120">2 Hours</option>
                    </select>
                </div>
                <button type="submit" class="gradient-button">Save Session</button>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content floating-card glass-effect">
            <button class="modal-close-btn" data-modal-id="confirm-modal">&times;</button>
            <h3 class="gradient-text">Are you sure?</h3>
            <p id="confirm-modal-message">Do you really want to cancel this item?</p>
            <div id="confirm-buttons">
                <button id="confirm-btn-yes" class="gradient-button">Yes, Confirm</button>
                <button id="confirm-btn-no" class="secondary-button">No</button>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="video-player-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="video-player-modal">&times;</button>
            <h3 id="video-title" class="gradient-text"></h3>
            <div class="video-wrapper">
                <iframe id="youtube-iframe" src="" allow="encrypted-media; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Marks Modal Popup - Enhanced with Better Styling -->
    <div id="marks-modal" class="marks-modal-overlay hidden">
        <div class="marks-modal-content floating-card glass-effect">
            <button class="modal-close-btn" onclick="closeMarksModal()">&times;</button>
            <h3 id="marks-modal-title" class="gradient-text">Subject Test History</h3>
            <div id="marks-modal-content">
                <!-- Test history items will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Live Session Page -->
    <div id="live-session-page" class="hidden">
        <div class="live-session-header-bar glass-effect">
            <h1 id="live-session-title" class="gradient-text"></h1>
            <div class="live-session-header-controls">
                <span id="live-session-timer">00:00</span>
                <button id="live-take-test-btn" class="secondary-button">Take Test</button>
                <button id="pause-session-btn" class="secondary-button">Pause Session</button>
                <button id="end-session-btn" class="action-btn">End Session</button>
            </div>
        </div>

        <div class="live-session-content-area">
            <h2 class="gradient-text">üìπ Video Resources & Edubot</h2>

            <div class="search-bar-live floating-card glass-effect">
                <input type="text" id="liveSearchInput" placeholder="Search YouTube for videos on this topic..." />
                <button id="liveSearchBtn" class="gradient-button">Refresh Videos</button>
            </div>

            <div class="loader" id="liveLoader">
                <div class="theme-loader"></div>
            </div>
            <section class="videos-section" id="videosSection"></section>
        </div>
    </div>

    <!-- Floating Icons -->
    <div id="pdf-icon" class="floating-action-icon">üìÑ</div>
    <div id="chatbot-icon" class="floating-action-icon">üí¨</div>

    <!-- Chatbot Container -->
    <div id="chatbot-container" class="floating-window">
        <div id="chatbot-header">
            <span>Edubot</span>
            <button id="close-btn">&times;</button>
        </div>
        <div id="chatbot-body">
            <div id="chatbot-messages"></div>
        </div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Type a message..." />
            <button id="send-btn">Send</button>
        </div>
    </div>

    <!-- PDF Container -->
    <div id="pdf-container" class="floating-window">
        <div id="pdf-header">
            <span>Notes & PDFs</span>
            <button id="pdf-close-btn">&times;</button>
        </div>
        <div id="pdf-body">
            <div class="pdf-item">
                <h4>Chapter 5 - Thermodynamics.pdf</h4>
                <p>Uploaded 3 days ago</p>
            </div>
            <div class="pdf-item">
                <h4>WW1 Key Dates.pdf</h4>
                <p>Uploaded 1 week ago</p>
            </div>
        </div>
    </div>
    <!-- Quiz Modal - Add this before closing </body> tag -->
    <div id="quiz-modal" class="modal hidden">
        <div class="modal-content" style="width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close-btn" data-modal-id="quiz-modal">&times;</button>

            <div id="quiz-loading" style="text-align: center; padding: 3rem;">
                <div class="theme-loader" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-dark);">Generating quiz questions...</p>
            </div>

            <div id="quiz-content" class="hidden">
                <div class="quiz-header" style="position: relative; margin-bottom: 2rem;">
                    <h2 id="quiz-topic-title" class="gradient-text" style="font-size: 1.8rem;">Quiz</h2>
                </div>

                <div class="question-nav" id="quiz-question-nav"
                    style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
                </div>

                <div id="quiz-questions-wrapper" style="position: relative; min-height: 400px;"></div>

                <div id="quiz-nav-buttons" style="display: none; gap: 1rem; margin-top: 2rem;">
                    <button class="secondary-button" id="quiz-prev-btn" onclick="quizPrevQuestion()">‚Üê Previous</button>
                    <button class="secondary-button" id="quiz-next-btn" onclick="quizNextQuestion()">Next ‚Üí</button>
                    <button class="gradient-button" id="quiz-submit-btn" onclick="submitQuizAnswers()"
                        style="display: none;">
                        Submit Quiz
                    </button>
                </div>

                <div id="quiz-results-container" style="display: none;"></div>
            </div>
        </div>
    </div>
    <!-- Toast Container for Notifications -->
    <div id="toast-container"></div>
    <script>
        // Global variable to store the origin position
        let marksModalOrigin = { x: 0, y: 0 };
        // =================================================================
        // DATA STORE & GLOBAL CONFIG
        // =================================================================

        // ‚ö†Ô∏è IMPORTANT: Replace these with your actual keys
        const YOUTUBE_API_KEY = "AIzaSyCvkGuq2MLm8lpNxhr5NVXszlr2FQjjn6g";
        const GEMINI_API_KEY = "AIzaSyAVmuy_bEGikeYncyr4Y0gPA_hv3DiCP5U";

        const DEFAULT_GRADE = "Grade 9";
        const DEFAULT_CURRICULUM = "NCERT";

        // Default Data
        const defaultSessions = [
            { id: 1, title: "Quick Geometry Recap", type: "Session", subject: "Math", duration: 45, datetime: new Date(new Date().getTime() - 3600000).toISOString() },
            { id: 2, title: "The French Revolution", type: "Test", subject: "History", duration: 60, datetime: new Date(new Date().getTime() + 120000).toISOString() },
            { id: 3, title: "Laws of Motion (Revision)", type: "Session", subject: "Physics", duration: 90, datetime: new Date(new Date().getTime() + 86400000).toISOString() }
        ];
        const defaultTimetable = [
            { title: "Midterm Exam", subject: "Calculus", date: "2026-01-10", time: "09:00 AM", status: "Upcoming" },
            { title: "Final Project Due", subject: "Computer Science", date: "2026-01-25", time: "11:59 PM", status: "Drafting" }
        ];
        const defaultResources = [
            { type: "pdf", title: "Thermodynamics Chapter 5 Notes", subject: "Physics" },
            { type: "video", title: "Calculus Integration Tutorial", subject: "Math" },
            { type: "photo", title: "WWI Key Dates Infographic", subject: "History" }
        ];

        // ‚ú® NEW: Placeholder data for previous marks/test history
        const previousMarksData = {
            "Math": [
                { name: "Test 1: Algebra", score: "95%" },
                { name: "Test 2: Geometry", score: "89%" },
                { name: "Quiz 1: Trigonometry", score: "93%" }
            ],
            "Science": [
                { name: "Test 1: Biology", score: "88%" },
                { name: "Test 2: Physics", score: "82%" }
            ],
            "History": [
                { name: "Test 1: WW1", score: "90%" },
                { name: "Test 2: Ancient Civilizations", score: "91%" }
            ],
            "Physics": [
                { name: "Test 1: Motion", score: "90%" },
                { name: "Test 2: Optics", score: "86%" }
            ],
            "English": [
                { name: "Essay 1", score: "94%" },
                { name: "Grammar Test", score: "96%" }
            ],
            "Chemistry": [
                { name: "Test 1: Moles", score: "80%" },
                { name: "Test 2: Bonds", score: "86%" }
            ]
        };

        // Main Data Arrays
        let sessions = [];
        let examTimetableData = [];
        let resourcesData = [];

        let sessionToCancel = null;
        let sessionToEdit = null;
        let currentSessionId = null;
        let currentNextPageToken = null;
        let sessionTimerInterval = null;
        let sessionStartTime = 0;
        let sessionElapsedSeconds = 0;
        let sessionTotalDuration = 0;
        let sessionPaused = false;
        let pausedSessionData = null; // NEW: Store paused session data

        // =================================================================
        // AI SESSION STATE & DATA (NEW)
        // =================================================================

        let aiSessionState = {
            active: false,
            topic: "",
            subject: "",
            concepts: [],
            currentConceptIndex: 0,
            videoWatched: false,
            quizAnswered: false,
            scores: {},
            overallProgress: 0
        };

        // =================================================================
        // GEMINI API CONFIGURATION
        // =================================================================

        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

        // =================================================================
        // DYNAMIC AI SESSION GENERATION
        // =================================================================

        /**
         * Generate topic breakdown using Gemini API
         */
        async function generateTopicBreakdown(topic, subject) {
            const prompt = `Generate a structured learning plan for the topic: "${topic}" in the subject: "${subject}".

Break it down into 3-5 key concepts that should be learned in sequence.
For each concept, provide:
1. A clear concept name (2-5 words)
2. A YouTube search query to find relevant educational videos

Respond ONLY with valid JSON in this exact format:
[
  {
    "name": "Concept Name",
    "videoQuery": "search query for YouTube"
  }
]

Do not include any markdown, explanations, or extra text - only the JSON array.`;

            try {
                // Use global API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;

                const jsonMatch = generatedText.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error('Invalid JSON response from Gemini');

                const concepts = JSON.parse(jsonMatch[0]);

                return concepts.map((concept, index) => ({
                    id: index + 1,
                    title: concept.name,
                    videoQuery: concept.videoQuery,
                    quiz: null // Will be generated dynamically
                }));

            } catch (error) {
                console.error('Error generating topic breakdown:', error);
                return generateFallbackConcepts(topic, subject);
            }
        }

        /**
         * Generate quiz question using Gemini API
         */
        async function generateQuizQuestion(conceptTitle, subject) {
            const prompt = `Create a multiple-choice quiz question to test understanding of: "${conceptTitle}" in ${subject}.

Requirements:
- 1 clear question
- 4 answer options  
- Indicate which option (0-3) is correct
- Include a brief explanation

Respond ONLY with valid JSON in this exact format:
{
  "question": "Question text?",
  "options": ["Option 1", "Option 2", "Option 3", "Option 4"],
  "correctIndex": 0,
  "explanation": "Explanation text"
}

Do not include any markdown or extra text.`;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;

                const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Invalid JSON response from Gemini');

                return JSON.parse(jsonMatch[0]);

            } catch (error) {
                console.error('Error generating quiz:', error);
                return {
                    question: `Review question for ${conceptTitle}`,
                    options: ["Understood", "Needs Review", "Skip", "Practice"],
                    correctIndex: 0,
                    explanation: "Self-assessment question due to generation error."
                };
            }
        }

        function generateFallbackConcepts(topic, subject) {
            return [
                { id: 1, title: `Intro to ${topic}`, videoQuery: `${topic} ${subject} introduction`, quiz: null },
                { id: 2, title: `Key Concepts: ${topic}`, videoQuery: `${topic} ${subject} key concepts`, quiz: null },
                { id: 3, title: `Applications of ${topic}`, videoQuery: `${topic} ${subject} applications`, quiz: null }
            ];
        }

        // Replaces old breakdownTopicIntoConcepts
        async function breakdownTopicIntoConcepts(topic, subject) {
            // Show loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'ai-loading-indicator';
            loadingMsg.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; color: white; flex-direction: column;">
                    <div class="theme-loader" style="width: 50px; height: 50px; border-width: 4px;"></div>
                    <h2 style="margin-top: 20px; font-weight: 300;">Generating AI Session Plan...</h2>
                    <p style="opacity: 0.7; margin-top: 10px;">Analyzing ${topic} using Gemini AI</p>
                </div>
            `;
            document.body.appendChild(loadingMsg);

            try {
                return await generateTopicBreakdown(topic, subject);
            } finally {
                const indicator = document.getElementById('ai-loading-indicator');
                if (indicator) indicator.remove();
            }
        }

        async function initAISession(topic, subject) { // Removed default 'Calculus'
            aiSessionState.active = true;
            aiSessionState.topic = topic;
            aiSessionState.subject = subject;
            aiSessionState.currentConceptIndex = 0;
            aiSessionState.videoWatched = false;
            aiSessionState.quizAnswered = false;
            aiSessionState.scores = {};
            aiSessionState.concepts = []; // Initialize empty

            // Create a temporary session object to open the live session page
            const tempSession = {
                id: Date.now(),
                title: topic,
                subject: subject,
                type: 'Session',
                datetime: new Date().toISOString(),
                duration: 60
            };

            // Open the live session page immediately
            openLiveSession(tempSession);

            // Fetch concepts asynchronously
            try {
                // Determine the correct context for the URL
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

                // Show loading state in the UI if possible, or reliance on breakdownTopicIntoConcepts' loader
                const concepts = await breakdownTopicIntoConcepts(topic, subject);
                aiSessionState.concepts = concepts;

                // Now replace content and load first concept
                renderAISessionLayout();
                loadConcept(0);
            } catch (error) {
                console.error("Failed to init AI session:", error);
                alert("Failed to generate session plan. Please check your API key.");
            }
        }

        function loadConcept(index) {
            if (index < 0 || index >= aiSessionState.concepts.length) {
                showAISessionCompletion();
                return;
            }

            aiSessionState.currentConceptIndex = index;
            aiSessionState.videoWatched = false;
            aiSessionState.quizAnswered = false;

            const concept = aiSessionState.concepts[index];

            // Update sidebar
            renderConceptsSidebar();

            // Load video
            searchAndPlayVideo(concept.videoQuery, concept.title);

            // Hide quiz initially
            const quizContainer = document.getElementById('ai-quiz-container');
            if (quizContainer) quizContainer.style.display = 'none';
        }

        function renderAISessionLayout() {
            // The live session page is already open via openLiveSession
            // We just need to replace the content with the AI layout

            const liveSessionContent = document.querySelector('.live-session-content-area');
            if (!liveSessionContent) {
                console.error('Live session content area not found');
                return;
            }

            // Inject the AI session layout (replacing YouTube search interface)
            liveSessionContent.innerHTML = `
                <div class="ai-session-container">
                    <div class="session-main-content">
                        <h2 class="gradient-text">üìö ${aiSessionState.topic}</h2>
                        
                        <!-- Video Container -->
                        <div class="ai-video-container" id="ai-video-container">
                            <h3 style="margin-top: 0;">Current Topic: Loading...</h3>
                            <div class="ai-video-wrapper" id="ai-video-wrapper">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div class="theme-loader"></div>
                                    <p style="margin-top: 20px; color: var(--subtext-dark);">Searching for educational video...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quiz Container (Hidden Initially) -->
                        <div class="ai-quiz-container" id="ai-quiz-container" style="display: none;">
                            <div class="quiz-header">
                                <h3 class="gradient-text">üìù Quiz Time!</h3>
                                <p style="margin: 0; color: var(--subtext-dark);">Answer the question to proceed</p>
                            </div>
                            <div id="ai-quiz-content"></div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="session-sidebar">
                        <h3 class="gradient-text" style="font-size: 1.2em; margin: 0 0 15px 0;">üìã Concepts</h3>
                        <div class="concepts-list" id="concepts-list"></div>

                        <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

                        <div class="progress-circle-container">
                            <div class="circular-progress">
                                <svg width="120" height="120">
                                    <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"></circle>
                                    <circle cx="60" cy="60" r="50" fill="none" stroke="url(#gradient)" stroke-width="8" 
                                        stroke-dasharray="314" stroke-dashoffset="314" id="ai-progress-circle"></circle>
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#0072ff" />
                                            <stop offset="100%" style="stop-color:#ff416c" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="progress-text">
                                    <span id="ai-progress-percentage">0%</span>
                                    <span class="progress-label">Complete</span>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            `;
        }


        // =================================================================
        // DOM ELEMENT REFERENCES
        // =================================================================
        const body = document.body;
        const mainContent = document.getElementById('self-study-main');
        const modeToggleCheckbox = document.getElementById('mode-toggle-checkbox');
        const sessionsContainer = document.getElementById('sessions-container');
        const timetableBody = document.getElementById('timetable-body');
        const resourcesContainer = document.getElementById('resources-container');

        // Modals
        const confirmModal = document.getElementById('confirm-modal');
        const videoPlayerModal = document.getElementById('video-player-modal');
        const sessionFormModal = document.getElementById('session-form-modal');
        const sessionForm = document.getElementById('session-form');
        const sessionFormTitle = document.getElementById('session-form-title');
        const marksModal = document.getElementById('marks-modal');

        const youtubeIframe = document.getElementById('youtube-iframe');
        const liveSessionPage = document.getElementById('live-session-page');

        // Live Session
        const liveSessionTimer = document.getElementById('live-session-timer');
        const pauseSessionBtn = document.getElementById('pause-session-btn');
        const endSessionBtn = document.getElementById('end-session-btn');
        const liveTakeTestBtn = document.getElementById('live-take-test-btn');
        const liveSearchInput = document.getElementById('liveSearchInput');
        const liveSearchBtn = document.getElementById('liveSearchBtn');
        const liveLoader = document.getElementById('liveLoader');
        const videosSection = document.getElementById('videosSection');

        // Chatbot & PDF Icons
        const pdfIcon = document.getElementById("pdf-icon");
        const chatbotIcon = document.getElementById("chatbot-icon");
        const chatbotContainer = document.getElementById("chatbot-container");
        const chatCloseBtn = document.getElementById("close-btn");
        const sendBtn = document.getElementById("send-btn");
        const chatInput = document.getElementById("chatbot-input");
        const chatbotMessages = document.getElementById("chatbot-messages");

        const pdfContainer = document.getElementById("pdf-container");
        const pdfCloseBtn = document.getElementById("pdf-close-btn");


        // =================================================================
        // LOCAL STORAGE FUNCTIONS
        // =================================================================

        function saveDataToLocalStorage() {
            localStorage.setItem('epicScholarSessions', JSON.stringify(sessions));
            localStorage.setItem('epicScholarTimetable', JSON.stringify(examTimetableData));
            localStorage.setItem('epicScholarResources', JSON.stringify(resourcesData));
        }

        function loadDataFromLocalStorage() {
            const savedSessions = localStorage.getItem('epicScholarSessions');
            const savedTimetable = localStorage.getItem('epicScholarTimetable');
            const savedResources = localStorage.getItem('epicScholarResources');

            sessions = savedSessions ? JSON.parse(savedSessions) : defaultSessions;
            examTimetableData = savedTimetable ? JSON.parse(savedTimetable) : defaultTimetable;
            resourcesData = savedResources ? JSON.parse(savedResources) : defaultResources;
        }

        // =================================================================
        // UTILITY & RENDER FUNCTIONS
        // =================================================================

        const revealCards = (containerSelector) => {
            document.querySelectorAll(`${containerSelector} .floating-card`).forEach((card, index) => {
                card.classList.remove('card-reveal');
                void card.offsetWidth;
                card.style.animationDelay = `${index * 100}ms`;
                card.classList.add('card-reveal');
            });
        };

        const openModal = (modalEl) => {
            modalEl.classList.remove('hidden', 'hiding');
        };

        const closeModal = (modalEl) => {
            modalEl.classList.add('hiding');
            modalEl.addEventListener('animationend', () => {
                modalEl.classList.add('hidden');
                modalEl.classList.remove('hiding');
                if (modalEl.id === 'video-player-modal') {
                    youtubeIframe.src = "";
                    document.getElementById('video-title').textContent = "";
                }
                if (modalEl.id === 'session-form-modal') {
                    sessionForm.reset();
                    sessionToEdit = null;
                    delete sessionForm.dataset.editId;
                }
            }, { once: true });
        };

        const playVideoInModal = (videoId, title) => {
            const embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0`;
            youtubeIframe.src = embedUrl;
            document.getElementById('video-title').textContent = title;
            openModal(videoPlayerModal);
        };

        const parseISODuration = (duration) => {
            if (!duration) return "0:00";

            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return "0:00";

            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);

            let result = "";
            if (hours > 0) {
                result += `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                result += `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            return result;
        };

        const renderSessions = () => {
            sessionsContainer.innerHTML = '';
            sessions.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card floating-card glass-effect';
                card.setAttribute('data-id', session.id);
                card.setAttribute('data-time', session.datetime);

                const sessionDate = new Date(session.datetime);
                const formattedDate = sessionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedTime = sessionDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                card.innerHTML = `
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit" data-action="edit-session">‚úèÔ∏è</button>
                    <button class="card-action-btn cancel-btn" title="Cancel" data-action="cancel-session">‚ùå</button>
                </div>
                <p class="session-title">üéØ ${session.title}</p>
                <p class="session-subject">Subject: ${session.subject || 'General'} (AI-Powered)</p>
                <p class="session-datetime">Scheduled: ${formattedDate} | ${formattedTime}</p>
                <p class="session-duration">Duration: ${session.duration} minutes</p>
                <button class="start-session-btn gradient-button" data-action="start-ai-session" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); border: none; padding: 14px 20px; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);">
                    ü§ñ Start AI Learning Session
                </button>
            `;
                sessionsContainer.appendChild(card);
            });
            revealCards('#sessions-container');
        };

        const renderTimetable = () => {
            timetableBody.innerHTML = '';
            examTimetableData.forEach(item => {
                const row = document.createElement('tr');
                const statusClass = item.status === 'Upcoming' ? 'style="color: var(--primary-color); font-weight: 600;"' : '';
                row.innerHTML = `
                <td>${item.title}</td>
                <td>${item.subject}</td>
                <td>${item.date}</td>
                <td>${item.time}</td>
                <td ${statusClass}>${item.status}</td>
            `;
                timetableBody.appendChild(row);
            });
        };

        const renderResources = () => {
            resourcesContainer.innerHTML = '';
            resourcesData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'resource-card floating-card glass-effect';
                card.setAttribute('data-type', item.type);

                let icon = 'üìÑ';
                if (item.type === 'video') icon = 'üìπ';
                if (item.type === 'photo') icon = 'üñºÔ∏è';

                card.innerHTML = `
                <span class="resource-icon">${icon}</span>
                <p class="resource-title">${item.title}</p>
                <p class="resource-subject">${item.subject}</p>
            `;
                resourcesContainer.appendChild(card);
            });
            revealCards('#resources-container');
        };

        const checkSessionStatus = () => {
            const now = new Date();
            document.querySelectorAll('.session-card').forEach(card => {
                const sessionTime = new Date(card.getAttribute('data-time'));
                const startBtn = card.querySelector('.start-session-btn');

                if (now >= sessionTime) {
                    card.classList.add('ready-to-start');
                    startBtn.classList.remove('hidden');
                } else {
                    card.classList.remove('ready-to-start');
                    startBtn.classList.add('hidden');
                }
            });
        };

        // =================================================================
        // AI SESSION BUTTON HELPERS
        // =================================================================

        // Check if a subject has AI/mock data available
        const hasAIMockData = (subject) => {
            const aiSubjects = ['calculus', 'physics'];
            return aiSubjects.some(s => subject.toLowerCase().includes(s.toLowerCase()));
        };


        // =================================================================
        // CHATBOT & PDF INTEGRATION
        // =================================================================

        chatbotIcon.addEventListener("click", () => {
            pdfContainer.classList.remove("visible");
            chatbotContainer.classList.add("visible");
            chatbotIcon.classList.remove("visible");
            pdfIcon.classList.add("visible");
        });

        chatCloseBtn.addEventListener("click", () => {
            chatbotContainer.classList.remove("visible");
            if (liveSessionPage.classList.contains('open')) {
                chatbotIcon.classList.add("visible");
                pdfIcon.classList.add("visible");
            }
        });

        pdfIcon.addEventListener("click", () => {
            chatbotContainer.classList.remove("visible");
            pdfContainer.classList.add("visible");
            pdfIcon.classList.remove("visible");
            chatbotIcon.classList.add("visible");
        });

        pdfCloseBtn.addEventListener("click", () => {
            pdfContainer.classList.remove("visible");
            if (liveSessionPage.classList.contains('open')) {
                chatbotIcon.classList.add("visible");
                pdfIcon.classList.add("visible");
            }
        });

        sendBtn.addEventListener("click", sendChatMessage);
        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendChatMessage();
        });

        function sendChatMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                appendChatMessage("user", userMessage);
                chatInput.value = "";
                getBotResponse(userMessage);
            }
        }

        function appendChatMessage(sender, message) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            messageElement.textContent = message;
            chatbotMessages.appendChild(messageElement);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        // =================================================================
        // ENHANCED CHATBOT WITH MARKDOWN, TTS, AND STREAMING
        // =================================================================

        /* ---------- TTS (Text-to-Speech) Logic ---------- */
        const synth = window.speechSynthesis;
        let currentUtterance = null;
        let currentReadBtn = null;
        let currentHighlightSpan = null;

        function resetReadButton() {
            if (currentReadBtn) {
                currentReadBtn.innerHTML = '<i class="fa-solid fa-volume-up"></i>';
                currentReadBtn.classList.remove('active');
                currentReadBtn = null;
            }
        }

        function stopSpeaking() {
            if (synth.speaking || synth.paused) {
                synth.cancel();
            }
            document.querySelectorAll('.message.reading-active').forEach(el => {
                el.classList.remove('reading-active');
            });
            removeHighlight();
            resetReadButton();
            currentUtterance = null;
        }

        function removeHighlight() {
            if (currentHighlightSpan && currentHighlightSpan.parentNode) {
                const parent = currentHighlightSpan.parentNode;
                while (currentHighlightSpan.firstChild) {
                    parent.insertBefore(currentHighlightSpan.firstChild, currentHighlightSpan);
                }
                parent.removeChild(currentHighlightSpan);
                parent.normalize();
                currentHighlightSpan = null;
            }
        }

        function highlightWord(rootElement, startIndex, wordLength) {
            removeHighlight();
            if (!rootElement || wordLength === 0) return;

            let charCount = 0;
            let startNode = null, startOffset = 0;
            let endNode = null, endOffset = 0;
            let foundStart = false, foundEnd = false;

            function traverse(node) {
                if (foundEnd) return;
                if (node.nodeType === 3) {
                    const nodeLength = node.textContent.length;
                    const nextCharCount = charCount + nodeLength;
                    if (!foundStart && startIndex >= charCount && startIndex < nextCharCount) {
                        startNode = node;
                        startOffset = startIndex - charCount;
                        foundStart = true;
                    }
                    if (foundStart && !foundEnd && (startIndex + wordLength) <= nextCharCount) {
                        endNode = node;
                        endOffset = (startIndex + wordLength) - charCount;
                        foundEnd = true;
                    }
                    charCount = nextCharCount;
                } else if (node.nodeType === 1) {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        traverse(node.childNodes[i]);
                    }
                }
            }

            traverse(rootElement);

            if (startNode && endNode && startNode === endNode) {
                const range = document.createRange();
                range.setStart(startNode, startOffset);
                range.setEnd(endNode, endOffset);
                const span = document.createElement('span');
                span.className = 'highlight-word';
                try {
                    range.surroundContents(span);
                    currentHighlightSpan = span;
                } catch (e) {
                    console.log('Skipping highlight across complex boundaries');
                }
            }
        }

        function readMessage(button) {
            if (synth.paused && currentReadBtn === button) {
                synth.resume();
                button.innerHTML = '<i class="fa-solid fa-pause"></i>';
                button.classList.add('active');
                return;
            }
            if (synth.speaking && currentUtterance && currentReadBtn === button) {
                synth.pause();
                button.innerHTML = '<i class="fa-solid fa-play"></i>';
                return;
            }
            stopSpeaking();

            const messageElement = button.closest('.message');
            const contentArea = messageElement.querySelector('.message-text');
            const messageText = contentArea.textContent;

            const utterance = new SpeechSynthesisUtterance(messageText);
            utterance.pitch = 1;
            utterance.rate = 1.0;

            messageElement.classList.add('reading-active');

            utterance.onboundary = (event) => {
                if (event.name === 'word') {
                    const len = event.charLength || ((messageText.substring(event.charIndex).match(/^\S+/) || [''])[0].length);
                    highlightWord(contentArea, event.charIndex, len);
                }
            };

            utterance.onstart = () => {
                button.innerHTML = '<i class="fa-solid fa-pause"></i>';
                button.classList.add('active');
            };

            utterance.onend = () => {
                resetReadButton();
                messageElement.classList.remove('reading-active');
                removeHighlight();
            };

            utterance.onerror = () => {
                resetReadButton();
                messageElement.classList.remove('reading-active');
                removeHighlight();
            };

            currentUtterance = utterance;
            currentReadBtn = button;
            synth.speak(utterance);
        }

        function copyToClipboard(button) {
            const messageElement = button.closest('.message');
            const messageText = messageElement.querySelector('.message-text').textContent;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(messageText).then(() => {
                    showToast('Copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy', 'fa-circle-xmark');
                });
            }
        }

        /* ---------- Toast Notification ---------- */
        function showToast(message, icon = 'fa-circle-check') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;

            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /* ---------- Markdown Formatter ---------- */
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatMarkdownToHtml(rawText) {
            if (!rawText) return '';
            const text = escapeHtml(rawText);

            const codeBlocks = [];
            let placeholderIndex = 0;
            const codeFenceRe = /```([\s\S]*?)```/g;
            const withPlaceholders = text.replace(codeFenceRe, (m, inner) => {
                const token = `@@CODE_BLOCK_${placeholderIndex}@@`;
                codeBlocks.push(inner);
                placeholderIndex++;
                return token;
            });

            const lines = withPlaceholders.split(/\r?\n/);
            let out = '';
            let inList = false;
            let listType = null;
            let inTable = false;
            let tableRows = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                if (/^\s*\|.*\|\s*$/.test(line)) {
                    inTable = true;
                    tableRows.push(line.trim());
                    continue;
                } else if (inTable) {
                    out += renderTableFromRows(tableRows);
                    tableRows = [];
                    inTable = false;
                }

                const hMatch = line.match(/^\s*(#{1,6})\s+(.*)$/);
                if (hMatch) {
                    if (inList) {
                        out += closeList(listType);
                        inList = false;
                        listType = null;
                    }
                    const level = hMatch[1].length;
                    out += `<h${level}>${inlineFormat(hMatch[2])}</h${level}>`;
                    continue;
                }

                const olMatch = line.match(/^\s*\d+\.\s+(.*)$/);
                const ulMatch = line.match(/^\s*[-*+]\s+(.*)$/);

                if (ulMatch || olMatch) {
                    const thisType = ulMatch ? 'ul' : 'ol';
                    const itemText = (ulMatch ? ulMatch[1] : olMatch[1]).trim();

                    if (!inList) {
                        out += `<${thisType}>`;
                        inList = true;
                        listType = thisType;
                    } else if (listType !== thisType) {
                        out += closeList(listType);
                        out += `<${thisType}>`;
                        listType = thisType;
                    }
                    out += `<li>${inlineFormat(itemText)}</li>`;
                    continue;
                } else {
                    if (inList) {
                        out += closeList(listType);
                        inList = false;
                        listType = null;
                    }
                }

                if (line.trim() === '') {
                    out += '<br/>';
                    continue;
                }

                out += `<p style="margin:0;padding:0;">${inlineFormat(line)}</p>`;
            }

            if (inList) out += closeList(listType);
            if (inTable && tableRows.length) out += renderTableFromRows(tableRows);

            let final = out;
            for (let j = 0; j < codeBlocks.length; j++) {
                const token = `@@CODE_BLOCK_${j}@@`;
                const raw = codeBlocks[j];
                final = final.split(token).join(`<pre class="code-block"><code>${raw.replace(/</g, '&lt;')}</code></pre>`);
            }

            final = final.replace(/(<br\/>\s*){2,}/g, '<br/>');
            return final;
        }

        function inlineFormat(s) {
            if (!s) return '';
            s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            s = s.replace(/(^|[^*])\*(?!\*)(.+?)\*(?!\*)/g, (m, p1, p2) => `${p1}<em>${p2}</em>`);
            s = s.replace(/:([a-z0-9_+-]+):/gi, (m, name) => {
                const map = { smile: 'üòä', thumbs_up: 'üëç', heart: '‚ù§Ô∏è', fire: 'üî•', star: '‚≠ê' };
                return map[name] || m;
            });
            s = s.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            return s;
        }

        function closeList(type) {
            return `</${type}>`;
        }

        function renderTableFromRows(rows) {
            if (!rows.length) return '';
            const parsed = rows.map(r => r.replace(/^\||\|$/g, '').split('|').map(c => c.trim()));
            if (parsed.length < 2) {
                return parsed.map(r => r.join(' | ')).map(cell => `<p>${inlineFormat(cell)}</p>`).join('');
            }
            const header = parsed[0];
            let html = '<table class="markdown-table"><thead><tr>';
            header.forEach(h => html += `<th>${inlineFormat(h)}</th>`);
            html += '</tr></thead><tbody>';
            for (let i = 1; i < parsed.length; i++) {
                const row = parsed[i];
                if (row.every(c => /^-+$/.test(c))) continue;
                html += '<tr>';
                row.forEach(c => html += `<td>${inlineFormat(c)}</td>`);
                html += '</tr>';
            }
            html += '</tbody></table>';
            return html;
        }

        /* ---------- Update existing chatbot send function ---------- */
        // Replace the existing getBotResponse function with this streaming version:

        let isStreamingChat = false;

        async function getBotResponse(userMessage) {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || !GEMINI_API_KEY) {
                appendChatMessage("bot", "Error: Gemini API Key is missing. Please set your key in the script.");
                return;
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            sendBtn.disabled = true;
            chatInput.disabled = true;

            // Show typing indicator
            const typingDiv = document.createElement("div");
            typingDiv.classList.add("message", "bot");
            typingDiv.innerHTML = `
        <div class="typing-container">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <span>EduBot is thinking</span>
        </div>
    `;
            chatbotMessages.appendChild(typingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userMessage }] }],
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "Unknown API error");
                }
                if (!data.candidates || !data.candidates.length) {
                    if (data.promptFeedback) {
                        console.warn("Prompt blocked:", data.promptFeedback);
                        throw new Error("Prompt was blocked. Please try a different question.");
                    }
                    throw new Error("No response from Gemini API");
                }

                const botMessage = data.candidates[0].content.parts[0].text;

                // Remove typing indicator
                typingDiv.remove();

                // Stream the response
                appendBotMessageStream(botMessage);

            } catch (error) {
                console.error("Error:", error);
                typingDiv.remove();
                appendChatMessage("bot", `Sorry, I'm having trouble responding: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                chatInput.disabled = false;
            }
        }

        function appendChatMessage(sender, message) {
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);

            const contentArea = document.createElement("div");
            contentArea.className = "message-text";
            contentArea.innerHTML = formatMarkdownToHtml(message);
            messageElement.appendChild(contentArea);

            if (sender === "bot") {
                const actionsBar = document.createElement('div');
                actionsBar.className = 'actions-bar';
                actionsBar.innerHTML = `
            <span class="timestamp-text">${timestamp}</span>
            <button class="action-btn" onclick="copyToClipboard(this)" title="Copy message">
                <i class="fa-solid fa-copy"></i>
            </button>
            <button class="action-btn" onclick="readMessage(this)" title="Read aloud">
                <i class="fa-solid fa-volume-up"></i>
            </button>
        `;
                messageElement.appendChild(actionsBar);
            }

            chatbotMessages.appendChild(messageElement);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        function appendBotMessageStream(text) {
            stopSpeaking();

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const div = document.createElement('div');
            div.className = 'message bot';

            const textContainer = document.createElement('div');
            textContainer.className = 'message-text';
            div.appendChild(textContainer);

            const actionsBar = document.createElement('div');
            actionsBar.className = 'actions-bar';
            div.appendChild(actionsBar);

            chatbotMessages.appendChild(div);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            const tokens = text.match(/[^.!?]+[.!?]|\s+|\S+/g) || [text];
            let idx = 0;
            let currentText = '';
            isStreamingChat = true;

            const pump = async () => {
                if (!isStreamingChat) {
                    finalizeStream();
                    return;
                }

                if (idx >= tokens.length) {
                    finalizeStream();
                    return;
                }

                const chunk = tokens[idx];
                currentText += chunk;
                idx++;

                const formatted = formatMarkdownToHtml(currentText);
                textContainer.innerHTML = formatted + `<span class="cursor"></span>`;

                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

                const delay = 35;
                await new Promise(r => setTimeout(r, delay));
                pump();
            };

            const finalizeStream = () => {
                textContainer.innerHTML = formatMarkdownToHtml(currentText);

                actionsBar.innerHTML = `
            <span class="timestamp-text">${timestamp}</span>
            <button class="action-btn" onclick="copyToClipboard(this)" title="Copy message">
                <i class="fa-solid fa-copy"></i>
            </button>
            <button class="action-btn" onclick="readMessage(this)" title="Read aloud">
                <i class="fa-solid fa-volume-up"></i>
            </button>
        `;

                isStreamingChat = false;
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            };

            pump();
        }

        // Add Font Awesome if not already included
        if (!document.querySelector('link[href*="font-awesome"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
            document.head.appendChild(link);
        }

        // =================================================================
        // LIVE SESSION CONTROL & YOUTUBE API HANDLING
        // =================================================================
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function updateSessionTimer() {
            if (sessionPaused) return;

            sessionElapsedSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
            const remainingSeconds = Math.max(0, sessionTotalDuration - sessionElapsedSeconds);

            liveSessionTimer.textContent = formatTime(remainingSeconds);

            // Auto-end session when time runs out
            if (remainingSeconds <= 0) {
                clearInterval(sessionTimerInterval);
                showSessionCompletionDialog();
            }
        }
        function showSessionCompletionDialog() {
            const userChoice = confirm("Session time completed! Would you like to add more time?\n\nClick 'OK' to add more time\nClick 'Cancel' to end the session");

            if (userChoice) {
                // Prompt user to enter additional minutes
                const additionalMinutes = prompt("How many additional minutes would you like to add?", "15");

                if (additionalMinutes !== null && additionalMinutes.trim() !== "") {
                    const minutes = parseInt(additionalMinutes);

                    if (!isNaN(minutes) && minutes > 0) {
                        // Add the specified minutes
                        sessionTotalDuration += minutes * 60;
                        sessionStartTime = Date.now() - (sessionElapsedSeconds * 1000);
                        sessionTimerInterval = setInterval(updateSessionTimer, 1000);
                        updateSessionTimer();

                        alert(`${minutes} minutes added to your session!`);
                    } else {
                        alert("Invalid input. Session will end.");
                        endSessionBtn.click();
                    }
                } else {
                    // User cancelled the prompt
                    endSessionBtn.click();
                }
            } else {
                // End the session
                endSessionBtn.click();
            }
        }
        const renderVideoResults = (videoItems) => {
            videosSection.innerHTML = '';
            if (!videoItems || videoItems.length === 0) {
                videosSection.innerHTML = '<h3 style="grid-column: 1 / -1; color: var(--subtext-dark);">No videos found for this search query.</h3>';
                return;
            }
            videoItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'youvideo';
                card.setAttribute('data-videoid', item.id);
                card.setAttribute('data-title', item.snippet.title);
                card.innerHTML = `
                <div class="thumbnail-container">
                    <img src="${item.snippet.thumbnails.high.url}" alt="${item.snippet.title}" />
                    <span class="video-duration">${parseISODuration(item.contentDetails.duration)}</span>
                </div>
                <h3>${item.snippet.title}</h3>
                <p>Channel: ${item.snippet.channelTitle}</p>
            `;
                card.addEventListener('click', () => playVideoInModal(item.id, item.snippet.title));
                videosSection.appendChild(card);
            });
        }

        async function fetchVideoDetails(videoIds) {
            if (YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY_HERE" || !YOUTUBE_API_KEY) {
                videosSection.innerHTML = '<h3 style="grid-column: 1 / -1; color: var(--warning-color);">Error: YouTube API Key is not set. Video search is disabled.</h3>';
                liveLoader.style.display = 'none';
                return;
            }
            const url = `https://www.googleapis.com/youtube/v3/videos?key=${YOUTUBE_API_KEY}&part=snippet,contentDetails&id=${videoIds}`;
            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) throw new Error(data.error.message);

                liveLoader.style.display = 'none';

                // Log to check if we're getting duration data
                console.log("Video details received:", data.items);

                renderVideoResults(data.items);
            } catch (err) {
                liveLoader.style.display = 'none';
                videosSection.innerHTML = `<h3 style="grid-column: 1 / -1; color: var(--secondary-color);">Failed to load video details: ${err.message}</h3>`;
                consoleerror("YouTube Video Details Fetch Error:", err);
            }
        }

        // =================================================================
        // AI SESSION HELPER FUNCTIONS (CONTINUED)
        // =================================================================

        async function searchAndPlayVideo(query, conceptTitle) {
            if (YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY_HERE" || !YOUTUBE_API_KEY) {
                document.getElementById('ai-video-wrapper').innerHTML = '<p style="color: var(--warning-color); text-align: center; padding: 40px;">YouTube API Key not configured</p>';
                return;
            }

            const videoContainer = document.getElementById('ai-video-container');
            const titleElement = videoContainer.querySelector('h3');
            if (titleElement) titleElement.textContent = `Current Topic: ${conceptTitle}`;

            const searchUrl = `https://www.googleapis.com/youtube/v3/search?key=${YOUTUBE_API_KEY}&q=${encodeURIComponent(query)}&part=snippet&type=video&videoDuration=medium&maxResults=1`;

            try {
                const res = await fetch(searchUrl);
                const data = await res.json();

                if (data.error) throw new Error(data.error.message);

                if (data.items && data.items.length > 0) {
                    const videoId = data.items[0].id.videoId;
                    playAIVideo(videoId);
                } else {
                    document.getElementById('ai-video-wrapper').innerHTML = '<p style="color: var(--subtext-dark); text-align: center; padding: 40px;">No video found for this topic</p>';
                }
            } catch (err) {
                console.error("AI Video Search Error:", err);
                document.getElementById('ai-video-wrapper').innerHTML = `<p style="color: var(--secondary-color); text-align: center; padding: 40px;">Error: ${err.message}</p>`;
            }
        }

        function playAIVideo(videoId) {
            const wrapper = document.getElementById('ai-video-wrapper');
            wrapper.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?enablejsapi=1" 
                    allowfullscreen
                    id="ai-youtube-player">
                </iframe>
                <button onclick="markVideoAsWatched()" class="action-btn" style="margin-top: 15px; width: 100%;">
                    ‚úì I've Finished Watching - Show Quiz
                </button>
            `;
        }

        async function markVideoAsWatched() {
            aiSessionState.videoWatched = true;

            const concept = aiSessionState.concepts[aiSessionState.currentConceptIndex];

            // If quiz not yet generated, generate it now
            if (!concept.quiz) {
                const quizContainer = document.getElementById('ai-quiz-container');
                quizContainer.style.display = 'block';
                document.getElementById('ai-quiz-content').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div class="theme-loader" style="margin: 0 auto;"></div>
                        <p class="gradient-text" style="margin-top: 15px;">ü§ñ AI is crafting a quiz for you...</p>
                    </div>
                `;

                try {
                    const quiz = await generateQuizQuestion(concept.title, aiSessionState.subject);
                    concept.quiz = quiz;
                } catch (e) {
                    console.error("Quiz generation failed", e);
                    concept.quiz = {
                        question: "What was the main topic?",
                        options: ["Topic A", "Topic B", "Topic C", "Topic D"],
                        correctIndex: 0,
                        explanation: "Fallback quiz due to error."
                    };
                }
            }

            showQuiz();
        }

        function showQuiz() {
            const concept = aiSessionState.concepts[aiSessionState.currentConceptIndex];
            const quizContainer = document.getElementById('ai-quiz-container');
            const quizContent = document.getElementById('ai-quiz-content');

            if (!concept || !concept.quiz) return;

            quizContent.innerHTML = `
                <div class="quiz-question">${concept.quiz.question}</div>
                <div class="quiz-options">
                    ${concept.quiz.options.map((option, idx) => `
                        <div class="quiz-option" onclick="selectQuizOption(${idx})">
                            ${option}
                        </div>
                    `).join('')}
                </div>
                <div id="quiz-feedback"></div>
            `;

            quizContainer.style.display = 'block';
            quizContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function selectQuizOption(selectedIndex) {
            if (aiSessionState.quizAnswered) return;

            const concept = aiSessionState.concepts[aiSessionState.currentConceptIndex];
            const isCorrect = selectedIndex === concept.quiz.correctIndex;

            aiSessionState.quizAnswered = true;
            aiSessionState.scores[aiSessionState.currentConceptIndex] = isCorrect ? 100 : 0;

            // Update UI
            const options = document.querySelectorAll('.quiz-option');
            options.forEach((opt, idx) => {
                opt.style.pointerEvents = 'none';
                if (idx === concept.quiz.correctIndex) {
                    opt.classList.add('correct');
                } else if (idx === selectedIndex) {
                    opt.classList.add('incorrect');
                }
            });

            // Show feedback
            const feedback = document.getElementById('quiz-feedback');
            feedback.className = isCorrect ? 'quiz-feedback correct' : 'quiz-feedback incorrect';
            feedback.innerHTML = `
                <strong>${isCorrect ? '‚úì Correct!' : '‚úó Incorrect'}</strong>
                <p>${concept.quiz.explanation}</p>
                ${!isCorrect ? `<p style="margin-top: 10px;"><em>The correct answer was: ${concept.quiz.options[concept.quiz.correctIndex]}</em></p>` : ''}
            `;

            // Update progress
            updateProgress();

            // Determine next action based on adaptive logic
            const nextAction = determineNextConcept(isCorrect);

            setTimeout(() => {
                feedback.innerHTML += `<button onclick="${nextAction.action}" class="action-btn" style="margin-top: 15px; width: 100%;">${nextAction.label}</button>`;
            }, 1500);
        }

        function determineNextConcept(isCorrect) {
            const currentIndex = aiSessionState.currentConceptIndex;
            const totalConcepts = aiSessionState.concepts.length;

            if (isCorrect) {
                // Correct answer - proceed to next concept
                if (currentIndex + 1 < totalConcepts) {
                    return {
                        action: `loadConcept(${currentIndex + 1})`,
                        label: '‚Üí Continue to Next Concept'
                    };
                } else {
                    return {
                        action: 'showAISessionCompletion()',
                        label: 'üéâ Complete Session'
                    };
                }
            } else {
                // Incorrect answer - review or retry
                return {
                    action: `loadConcept(${currentIndex})`,
                    label: '‚Ü∫ Review This Concept Again'
                };
            }
        }

        function renderConceptsSidebar() {
            const conceptsList = document.getElementById('concepts-list');
            if (!conceptsList) return;

            conceptsList.innerHTML = aiSessionState.concepts.map((concept, idx) => {
                let className = 'concept-item';
                if (idx === aiSessionState.currentConceptIndex) className += ' active';
                if (aiSessionState.scores[idx] !== undefined) className += ' completed';

                return `<div class="${className}" onclick="loadConcept(${idx})">${concept.title}</div>`;
            }).join('');
        }

        function updateProgress() {
            const completed = Object.keys(aiSessionState.scores).length;
            const total = aiSessionState.concepts.length;
            const percentage = Math.round((completed / total) * 100);

            aiSessionState.overallProgress = percentage;

            // Update progress circle
            const circle = document.getElementById('ai-progress-circle');
            const text = document.getElementById('ai-progress-percentage');

            if (circle && text) {
                const circumference = 314; // 2 * œÄ * 50
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                text.textContent = `${percentage}%`;
            }

            // Update concepts sidebar
            renderConceptsSidebar();
        }

        function showAISessionCompletion() {
            const liveSessionContent = document.querySelector('.live-session-content-area');
            if (!liveSessionContent) return;

            const correctAnswers = Object.values(aiSessionState.scores).filter(s => s === 100).length;
            const totalQuestions = aiSessionState.concepts.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);

            let message, emoji;
            if (percentage === 100) {
                emoji = 'üéâ';
                message = 'Perfect Score! You\'ve mastered this topic!';
            } else if (percentage >= 70) {
                emoji = '‚≠ê';
                message = 'Excellent work! You have a strong understanding!';
            } else if (percentage >= 50) {
                emoji = 'üëç';
                message = 'Good job! Keep practicing to improve further!';
            } else {
                emoji = 'üìö';
                message = 'Keep learning! Review the concepts and try again.';
            }

            liveSessionContent.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 6em; margin-bottom: 20px;">${emoji}</div>
                    <h1 class="gradient-text" style="font-size: 2.5em; margin-bottom: 15px;">Session Complete!</h1>
                    <p style="font-size: 1.3em; color: var(--subtext-dark); margin-bottom: 30px;">${message}</p>
                    
                    <div style="display: inline-block; background: var(--card-dark); padding: 30px 50px; border-radius: 20px; margin-bottom: 40px;">
                        <div class="quiz-score-circle" style="width: 180px; height: 180px; margin: 0 auto;">
                            <div class="quiz-score-number">${correctAnswers}/${totalQuestions}</div>
                            <div class="quiz-score-label">${percentage}% Correct</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="initAISession('${aiSessionState.topic}', '${aiSessionState.subject}')" class="gradient-button">
                            ‚Ü∫ Restart Session
                        </button>
                        <button onclick="endSessionBtn.click()" class="secondary-button">
                            ‚Üê Back to Dashboard
                        </button>
                    </div>

                    <div style="margin-top: 40px; padding: 20px; background: rgba(0, 114, 255, 0.1); border-radius: 12px; border: 1px solid var(--primary-color);">
                        <h3 style="margin-top: 0;">üìä Summary</h3>
                        <p>Topic: <strong>${aiSessionState.topic}</strong></p>
                        <p>Concepts Covered: <strong>${totalQuestions}</strong></p>
                        <p>Correct Answers: <strong>${correctAnswers}</strong></p>
                    </div>
                </div>
            `;

            aiSessionState.active = false;
        }

        async function performYouTubeSearch(query, pageToken = null) {
            if (YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY_HERE" || !YOUTUBE_API_KEY) {
                videosSection.innerHTML = '<h3 style="grid-column: 1 / -1; color: var(--warning-color);">Error: YouTube API Key is not set. Video search is disabled.</h3>';
                liveLoader.style.display = 'none';
                return;
            }

            if (!query) return;
            videosSection.innerHTML = '';
            liveLoader.style.display = 'flex';

            let searchUrl = `https://www.googleapis.com/youtube/v3/search?key=${YOUTUBE_API_KEY}&q=${encodeURIComponent(query)}&part=snippet&type=video&videoDuration=medium&maxResults=12`;
            if (pageToken) {
                searchUrl += `&pageToken=${pageToken}`;
            }

            try {
                const res = await fetch(searchUrl);
                const data = await res.json();

                if (data.error) throw new Error(data.error.message);

                currentNextPageToken = data.nextPageToken;
                liveSearchBtn.disabled = !currentNextPageToken;

                if (data.items && data.items.length > 0) {
                    const videoIds = data.items.map(item => item.id.videoId).join(',');
                    await fetchVideoDetails(videoIds);
                } else {
                    liveLoader.style.display = 'none';
                    videosSection.innerHTML = '<h3 style="grid-column: 1 / -1; color: var(--subtext-dark);">No more videos found.</h3>';
                }

            } catch (err) {
                liveLoader.style.display = 'none';
                videosSection.innerHTML = `<h3 style="grid-column: 1 / -1; color: var(--secondary-color);">Failed to load videos: ${err.message}</h3>`;
                console.error("YouTube Search Fetch Error:", err);
            }
        }
        const openLiveSession = (session) => {
            currentSessionId = session.id;

            document.getElementById('live-session-title').textContent = session.title;
            liveSessionPage.classList.remove('hidden', 'hiding');
            void liveSessionPage.offsetWidth;
            liveSessionPage.classList.add('open');
            mainContent.classList.add('hiding');

            // Check if resuming a paused session
            if (pausedSessionData && pausedSessionData.id === session.id) {
                // Resume from paused state
                sessionTotalDuration = pausedSessionData.totalDuration;
                sessionElapsedSeconds = pausedSessionData.elapsedSeconds;
                sessionPaused = false;
                sessionStartTime = Date.now() - (sessionElapsedSeconds * 1000);

                // Restore chat history
                chatbotMessages.innerHTML = pausedSessionData.chatHistory;

                pausedSessionData = null; // Clear paused data
            } else {
                // Start new session
                sessionTotalDuration = session.duration * 60; // Convert minutes to seconds
                sessionElapsedSeconds = 0;
                sessionPaused = false;
                sessionStartTime = Date.now();

                const initialPrompt = `Summarize key concepts for: ${session.title} (${session.subject}) from ${DEFAULT_CURRICULUM} ${DEFAULT_GRADE} syllabus.`;
                chatInput.value = initialPrompt;
                chatbotMessages.innerHTML = '';
                appendChatMessage("bot", "Welcome! The Edubot is active. Ask me anything or use the pre-filled prompt to start.");
            }

            pauseSessionBtn.textContent = "Pause Session";
            updateSessionTimer();
            sessionTimerInterval = setInterval(updateSessionTimer, 1000);

            chatInput.disabled = false;

            pdfIcon.classList.add('visible');
            chatbotIcon.classList.add('visible');
            chatbotContainer.classList.remove('visible');
            pdfContainer.classList.remove('visible');

            liveSearchInput.value = `${session.title} ${session.subject} tutorial`;
            liveSearchInput.disabled = true;
            liveSearchBtn.textContent = "Refresh Videos";
            liveSearchBtn.disabled = false;
            performYouTubeSearch(liveSearchInput.value);

            liveSearchBtn.onclick = () => performYouTubeSearch(liveSearchInput.value, currentNextPageToken);
        };

        const closeLiveSession = () => {
            liveSessionPage.classList.remove('open');
            liveSessionPage.classList.add('hiding');
            mainContent.classList.remove('hiding');

            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
            sessionPaused = false;
            sessionElapsedSeconds = 0;
            sessionTotalDuration = 0;

            pdfIcon.classList.remove('visible');
            chatbotIcon.classList.remove('visible');
            chatbotContainer.classList.remove('visible');
            pdfContainer.classList.remove('visible');
            chatInput.disabled = false;
            chatInput.value = "";

            videosSection.innerHTML = '';
            liveLoader.style.display = 'none';
            liveSearchBtn.onclick = null;
            currentNextPageToken = null;
            currentSessionId = null;

            liveSessionPage.addEventListener('transitionend', () => {
                liveSessionPage.classList.add('hidden');
                liveSessionPage.classList.remove('hiding');
            }, { once: true });
        };


        // =================================================================
        // MASTER EVENT HANDLERS & INITIALIZATION
        // =================================================================

        const openSessionForm = (type, sessionId = null) => {
            if (sessionId) {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                sessionFormTitle.textContent = `Edit ${session.type}`;
                sessionForm.dataset.type = session.type;
                sessionForm.dataset.editId = sessionId;

                document.getElementById('session-title').value = session.title;
                document.getElementById('session-subject').value = session.subject;

                const sessionDate = new Date(session.datetime);
                const localDate = new Date(sessionDate.getTime() - sessionDate.getTimezoneOffset() * 60000).toISOString().split('T')[0];
                const localTime = sessionDate.toTimeString().split(' ')[0].substring(0, 5);

                document.getElementById('session-date').value = localDate;
                document.getElementById('session-time').value = localTime;
                document.getElementById('session-duration').value = session.duration.toString();
            } else {
                sessionFormTitle.textContent = `Add New ${type}`;
                sessionForm.dataset.type = type;
                delete sessionForm.dataset.editId;

                const now = new Date();
                const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().split('T')[0];
                const localTime = now.toTimeString().split(' ')[0].substring(0, 5);
                document.getElementById('session-date').value = localDate;
                document.getElementById('session-time').value = localTime;
            }

            openModal(sessionFormModal);
        };

        sessionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(sessionForm);
            const editId = sessionForm.dataset.editId;

            if (editId) {
                const sessionIndex = sessions.findIndex(s => s.id === parseInt(editId));
                if (sessionIndex !== -1) {
                    sessions[sessionIndex] = {
                        ...sessions[sessionIndex],
                        title: formData.get('title'),
                        subject: formData.get('subject'),
                        duration: parseInt(formData.get('duration')),
                        datetime: new Date(`${formData.get('date')}T${formData.get('time')}`).toISOString()
                    };
                }
            } else {
                const newSession = {
                    id: Date.now(),
                    title: formData.get('title'),
                    type: sessionForm.dataset.type,
                    subject: formData.get('subject'),
                    duration: parseInt(formData.get('duration')),
                    datetime: new Date(`${formData.get('date')}T${formData.get('time')}`).toISOString()
                };
                sessions.push(newSession);
            }

            saveDataToLocalStorage();
            renderSessions();
            closeModal(sessionFormModal);
        });

        pauseSessionBtn.addEventListener('click', () => {
            // Pause session and close live session view
            sessionPaused = true;
            clearInterval(sessionTimerInterval);

            // Save current session state
            const currentSession = sessions.find(s => s.id === currentSessionId);
            pausedSessionData = {
                id: currentSessionId,
                session: currentSession,
                elapsedSeconds: sessionElapsedSeconds,
                totalDuration: sessionTotalDuration,
                chatHistory: chatbotMessages.innerHTML
            };

            // Update the session card to show "Resume Session" button
            const sessionCard = document.querySelector(`.session-card[data-id="${currentSessionId}"]`);
            if (sessionCard) {
                const startBtn = sessionCard.querySelector('.start-session-btn');
                if (startBtn) {
                    startBtn.textContent = `Resume Session (${formatTime(sessionTotalDuration - sessionElapsedSeconds)} left)`;
                    startBtn.classList.remove('hidden');
                }
            }

            // Close live session view
            closeLiveSession();
        });

        endSessionBtn.addEventListener('click', () => {
            if (currentSessionId) {
                sessions = sessions.filter(s => s.id !== currentSessionId);
                saveDataToLocalStorage();
                renderSessions();
            }
            closeLiveSession();
        });

        // Replace the existing liveTakeTestBtn event listener with this:

        liveTakeTestBtn.addEventListener('click', () => {
            // Get the current session details
            const currentSession = sessions.find(s => s.id === currentSessionId);
            if (currentSession) {
                // Generate quiz based on the session's topic and subject
                generateQuizForSession(currentSession.title, currentSession.subject);
            } else {
                alert("Session information not found. Please try again.");
            }
        });

        // Global Click Handler
        document.addEventListener('click', (e) => {
            const target = e.target;
            const action = target.closest('[data-action]')?.dataset.action;

            // Modal Close
            if (target.classList.contains('modal')) {
                closeModal(target.closest('.modal'));
            }
            if (target.closest('.modal-close-btn')) {
                const modalId = target.closest('.modal-close-btn').getAttribute('data-modal-id');
                if (modalId) {
                    if (modalId === 'marks-modal') {
                        closeMarksModal();
                    } else {
                        closeModal(document.getElementById(modalId));
                    }
                }
            }

            // Header Buttons
            if (target.closest('#add-session-btn')) {
                openSessionForm('Session');
            }
            if (target.closest('#add-test-btn')) {
                openSessionForm('Test');
            }

            // ‚ú® NEW: Enhanced Toggle Marks - Show popup with test history
            if (action === 'toggle-marks') {
                const box = target.closest('.subject-score-box');
                const subject = box.dataset.subject;
                const marks = previousMarksData[subject] || [];
                const marksContent = document.getElementById('marks-modal-content');
                const marksModal = document.getElementById('marks-modal');
                const modalContent = marksModal.querySelector('.marks-modal-content');

                // Store the origin position (center of the clicked box)
                const boxRect = box.getBoundingClientRect();
                marksModalOrigin = {
                    x: boxRect.left + boxRect.width / 2,
                    y: boxRect.top + boxRect.height / 2
                };

                document.getElementById('marks-modal-title').textContent = `${subject} - Test History`;
                marksContent.innerHTML = '';

                if (marks.length > 0) {
                    marks.forEach(mark => {
                        marksContent.innerHTML += `
                    <div class="mark-item">
                        <span class="mark-name">${mark.name}</span>
                        <span class="mark-score">${mark.score}</span>
                    </div>
                `;
                    });
                } else {
                    marksContent.innerHTML = `<p style="padding: 12px; text-align: center; color: var(--subtext-dark);">No test history found for ${subject}.</p>`;
                }

                // Calculate transform origin relative to modal content
                marksModal.classList.remove('hidden');

                // Force a reflow to ensure the modal is rendered before calculating positions
                void marksModal.offsetWidth;

                // Get modal position after it's rendered (but still invisible)
                const modalRect = modalContent.getBoundingClientRect();
                const deltaX = marksModalOrigin.x - (modalRect.left + modalRect.width / 2);
                const deltaY = marksModalOrigin.y - (modalRect.top + modalRect.height / 2);

                // Set transform origin to the clicked box position
                modalContent.style.transformOrigin = `calc(50% + ${deltaX}px) calc(50% + ${deltaY}px)`;

                // Show modal with animation
                setTimeout(() => {
                    marksModal.classList.add('visible');
                }, 10);
            }

            // AI Session Start
            if (action === 'start-ai-session') {
                const card = target.closest('.session-card');
                const sessionId = parseInt(card.getAttribute('data-id'));
                const session = sessions.find(s => s.id === sessionId);

                if (session) {
                    // Use session title and subject for AI session
                    initAISession(session.title, session.subject || 'General');
                }
            }

            // Session Card Actions
            if (action === 'start-session' || action === 'cancel-session' || action === 'edit-session') {
                const card = target.closest('.session-card');
                const sessionId = parseInt(card.getAttribute('data-id'));
                const session = sessions.find(s => s.id === sessionId);

                if (action === 'start-session' && session) {
                    if (session.type === 'Test') {
                        // Instead of redirecting to quiz.html, open the quiz modal
                        generateQuizForSession(session.title, session.subject);
                    } else {
                        // Check if this is a paused session being resumed
                        if (pausedSessionData && pausedSessionData.id === sessionId) {
                            openLiveSession(session);
                        } else {
                            openLiveSession(session);
                        }
                    }
                }

                if (action === 'edit-session' && session) {
                    openSessionForm(session.type, sessionId);
                }
                if (action === 'cancel-session' && session) {
                    sessionToCancel = sessionId;
                    document.getElementById('confirm-modal-message').textContent = `Do you really want to cancel "${session.title}"?`;
                    openModal(confirmModal);
                }
            }

            // Confirmation Modal Buttons
            if (target.closest('#confirm-btn-yes')) {
                if (sessionToCancel) {
                    sessions = sessions.filter(s => s.id !== sessionToCancel);
                    saveDataToLocalStorage();
                    renderSessions();
                    sessionToCancel = null;
                }
                closeModal(confirmModal);
            }
            if (target.closest('#confirm-btn-no')) {
                closeModal(confirmModal);
                sessionToCancel = null;
            }

            // ‚ú® NEW: Close marks modal when clicking outside
            if (target.id === 'marks-modal' && marksModal.classList.contains('visible')) {
                const modalContent = marksModal.querySelector('.marks-modal-content');
                if (!modalContent.contains(e.target)) {
                    closeMarksModal();
                }
            }
        });
        // Prevent clicks inside marks modal content from closing the modal
        document.querySelector('.marks-modal-content').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Function to close marks modal with animation back to origin
        function closeMarksModal() {
            const marksModal = document.getElementById('marks-modal');
            const modalContent = marksModal.querySelector('.marks-modal-content');

            // Calculate the scale and position to animate back to origin
            const modalRect = modalContent.getBoundingClientRect();
            const deltaX = marksModalOrigin.x - (modalRect.left + modalRect.width / 2);
            const deltaY = marksModalOrigin.y - (modalRect.top + modalRect.height / 2);

            // Set transform origin to the clicked box position
            modalContent.style.transformOrigin = `calc(50% + ${deltaX}px) calc(50% + ${deltaY}px)`;

            // Add closing class for animation
            marksModal.classList.add('closing');

            setTimeout(() => {
                marksModal.classList.remove('visible', 'closing');
                marksModal.classList.add('hidden');
                modalContent.style.transformOrigin = 'center';
            }, 400);
        }
        // Prevent clicks inside modal content from closing the modal
        document.querySelector('.marks-modal-content').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        // Theme Toggle Logic
        modeToggleCheckbox.addEventListener('change', () => {
            body.classList.toggle('dark-mode');
            body.classList.toggle('light-mode');
            localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        // Circular Progress Update
        function updateCircularProgress(percentage) {
            const circle = document.getElementById('progress-circle');
            const percentageText = document.getElementById('overall-percentage');

            if (!circle || !percentageText) return;

            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;

            circle.classList.remove('excellent', 'good', 'average', 'poor');
            if (percentage >= 85) {
                circle.classList.add('excellent');
            } else if (percentage >= 70) {
                circle.classList.add('good');
            } else if (percentage >= 50) {
                circle.classList.add('average');
            } else {
                circle.classList.add('poor');
            }

            percentageText.textContent = `${percentage}%`;
        }

        // INITIALIZATION BLOCK
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                modeToggleCheckbox.checked = true;
            } else {
                body.classList.add('dark-mode');
                body.classList.remove('light-mode');
                modeToggleCheckbox.checked = false;
            }

            loadDataFromLocalStorage();
            renderSessions();
            renderTimetable();
            renderResources();
            revealCards('.dashboard-grid');

            const overallPercentage = 88.5;
            updateCircularProgress(overallPercentage);

            setInterval(checkSessionStatus, 10000);
        });
        // Function to close marks modal
        // Function to close marks modal with animation back to origin
        function closeMarksModal() {
            const marksModal = document.getElementById('marks-modal');
            const modalContent = marksModal.querySelector('.marks-modal-content');

            // Calculate the scale and position to animate back to origin
            const modalRect = modalContent.getBoundingClientRect();
            const deltaX = marksModalOrigin.x - (modalRect.left + modalRect.width / 2);
            const deltaY = marksModalOrigin.y - (modalRect.top + modalRect.height / 2);

            // Set transform origin to the clicked box position
            modalContent.style.transformOrigin = `${deltaX}px ${deltaY}px`;

            // Add closing class for animation
            marksModal.classList.add('closing');

            setTimeout(() => {
                marksModal.classList.remove('visible', 'closing');
                marksModal.classList.add('hidden');
                modalContent.style.transformOrigin = 'center';
            }, 400);
        }
        // Quiz Variables - Add these at the top of your script section with other global variables
        let quizQuestions = [];
        let quizSelectedAnswers = {};
        let quizCurrentQuestion = 0;
        let quizShowResults = false;
        const QUIZ_API_KEY = "AIzaSyAVmuy_bEGikeYncyr4Y0gPA_hv3DiCP5U"; // Your quiz API key
        const QUIZ_MODEL_NAME = "gemini-2.5-flash";
        const QUIZ_NUM_QUESTIONS = 10;
        const QUIZ_DIFFICULTY = "medium";

        // Quiz Functions - Add these functions to your script section

        async function generateQuizForSession(topic, subject) {
            // Show modal and loading state
            const quizModal = document.getElementById('quiz-modal');
            const quizLoading = document.getElementById('quiz-loading');
            const quizContent = document.getElementById('quiz-content');

            // CRITICAL: Reset all UI elements to initial state
            quizLoading.classList.remove('hidden');
            quizContent.classList.add('hidden');
            document.getElementById('quiz-nav-buttons').style.display = 'none';
            document.getElementById('quiz-questions-wrapper').style.display = 'block';
            document.getElementById('quiz-question-nav').style.display = 'flex';
            document.getElementById('quiz-results-container').style.display = 'none';

            openModal(quizModal);

            // Reset quiz state
            quizQuestions = [];
            quizSelectedAnswers = {};
            quizCurrentQuestion = 0;
            quizShowResults = false;

            try {
                const fullTopic = `${topic} - ${subject}`;
                const prompt = `Generate ${QUIZ_NUM_QUESTIONS} multiple-choice quiz questions about "${fullTopic}" at ${QUIZ_DIFFICULTY} difficulty level for ${DEFAULT_GRADE} students following ${DEFAULT_CURRICULUM} curriculum.
        
        For each question, provide:
        1. The question text
        2. Four answer options (A, B, C, D)
        3. The correct answer (specify which letter)
        4. A brief explanation of why that answer is correct
        
        Format your response as valid JSON with this exact structure:
        {
          "questions": [
            {
              "question": "Question text here?",
              "options": {
                "A": "First option",
                "B": "Second option",
                "C": "Third option",
                "D": "Fourth option"
              },
              "correct": "A",
              "explanation": "Explanation here"
            }
          ]
        }`;

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${QUIZ_MODEL_NAME}:generateContent?key=${QUIZ_API_KEY}`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            maxOutputTokens: 16384,
                            temperature: 0.5,
                            responseMimeType: 'application/json'
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to generate quiz');
                }

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                const quizData = JSON.parse(generatedText);

                quizQuestions = quizData.questions;

                // Update UI
                document.getElementById('quiz-topic-title').textContent = `Quiz: ${fullTopic}`;
                quizLoading.classList.add('hidden');
                quizContent.classList.remove('hidden');

                renderQuizUI();

            } catch (err) {
                console.error('Quiz generation error:', err);
                quizLoading.innerHTML = `
            <div class="error-box" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                <span>‚ö†Ô∏è Failed to generate quiz: ${err.message}</span>
            </div>
            <button class="gradient-button" onclick="closeQuizModal()" style="margin-top: 1rem;">
                Close
            </button>
        `;
            }
        }

        function renderQuizUI() {
            renderQuizNavDots();
            renderQuizQuestions();
            document.getElementById('quiz-nav-buttons').style.display = 'flex';
            document.getElementById('quiz-results-container').style.display = 'none';
        }

        function renderQuizNavDots() {
            const nav = document.getElementById('quiz-question-nav');
            nav.innerHTML = '';
            quizQuestions.forEach((_, idx) => {
                const dot = document.createElement('div');
                dot.className = 'quiz-nav-dot';
                if (idx === quizCurrentQuestion) dot.classList.add('active');
                if (quizSelectedAnswers[idx]) dot.classList.add('answered');
                dot.onclick = () => goToQuizQuestion(idx);
                nav.appendChild(dot);
            });
        }

        function renderQuizQuestions() {
            const wrapper = document.getElementById('quiz-questions-wrapper');
            wrapper.innerHTML = '';

            quizQuestions.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = 'quiz-question-card';
                if (idx === quizCurrentQuestion) card.classList.add('active');
                else if (idx < quizCurrentQuestion) card.classList.add('prev');

                let optionsHTML = '';
                Object.entries(q.options).forEach(([letter, option]) => {
                    const isSelected = quizSelectedAnswers[idx] === letter;
                    const btnClass = isSelected ? 'quiz-option-btn selected' : 'quiz-option-btn';
                    optionsHTML += `<button class="${btnClass}" onclick="selectQuizAnswer(${idx}, '${letter}')"><strong>${letter}.</strong> ${option}</button>`;
                });

                card.innerHTML = `
            <div class="quiz-question-title gradient-text">${idx + 1}. ${q.question}</div>
            ${optionsHTML}
        `;

                wrapper.appendChild(card);
            });

            updateQuizNavigationButtons();
        }

        function selectQuizAnswer(questionIndex, answer) {
            if (!quizShowResults) {
                quizSelectedAnswers[questionIndex] = answer;
                renderQuizNavDots();
                renderQuizQuestions();
            }
        }

        function goToQuizQuestion(idx) {
            quizCurrentQuestion = idx;
            renderQuizQuestions();
            renderQuizNavDots();
        }

        function quizPrevQuestion() {
            if (quizCurrentQuestion > 0) {
                quizCurrentQuestion--;
                renderQuizQuestions();
                renderQuizNavDots();
            }
        }

        function quizNextQuestion() {
            if (quizCurrentQuestion < quizQuestions.length - 1) {
                quizCurrentQuestion++;
                renderQuizQuestions();
                renderQuizNavDots();
            }
        }

        function updateQuizNavigationButtons() {
            document.getElementById('quiz-prev-btn').disabled = quizCurrentQuestion === 0;
            document.getElementById('quiz-next-btn').style.display =
                quizCurrentQuestion === quizQuestions.length - 1 ? 'none' : 'block';
            document.getElementById('quiz-submit-btn').style.display =
                Object.keys(quizSelectedAnswers).length === quizQuestions.length &&
                    quizCurrentQuestion === quizQuestions.length - 1 ? 'block' : 'none';
        }

        function submitQuizAnswers() {
            quizShowResults = true;
            const score = calculateQuizScore();
            const percentage = (score / quizQuestions.length) * 100;

            let commentary, detail;
            if (percentage === 100) {
                commentary = "üéâ Perfect Score! Incredible!";
                detail = "You've mastered this topic completely. Outstanding performance!";
            } else if (percentage >= 80) {
                commentary = "üåü Excellent Work!";
                detail = "You have a strong understanding of this topic. Keep it up!";
            } else if (percentage >= 60) {
                commentary = "üëç Good Job!";
                detail = "You're on the right track. A bit more practice will make you excel!";
            } else if (percentage >= 40) {
                commentary = "üìö Keep Learning!";
                detail = "You've got the basics down. Review the material and try again!";
            } else {
                commentary = "üí™ Don't Give Up!";
                detail = "Learning takes time. Review the explanations and practice more!";
            }

            document.getElementById('quiz-nav-buttons').style.display = 'none';
            document.getElementById('quiz-question-nav').style.display = 'none';
            document.getElementById('quiz-questions-wrapper').style.display = 'none';

            const resultsContainer = document.getElementById('quiz-results-container');
            resultsContainer.style.display = 'flex';
            resultsContainer.innerHTML = `
        <div class="quiz-results-container">
            <div class="quiz-score-circle">
                <div class="quiz-score-number">${score}/${quizQuestions.length}</div>
                <div class="quiz-score-label">${percentage.toFixed(0)}%</div>
            </div>
            <div class="quiz-commentary gradient-text">${commentary}</div>
            <div class="quiz-commentary-detail">${detail}</div>
            <div style="display: flex; gap: 1rem; width: 100%; max-width: 500px;">
                <button class="gradient-button" onclick="reviewQuizAnswers()" style="flex: 1;">
                    Review Answers
                </button>
                <button class="secondary-button" onclick="closeQuizModal()" style="flex: 1;">
                    Close Quiz
                </button>
            </div>
        </div>
    `;
        }

        function calculateQuizScore() {
            let correct = 0;
            quizQuestions.forEach((q, idx) => {
                if (quizSelectedAnswers[idx] === q.correct) correct++;
            });
            return correct;
        }

        function reviewQuizAnswers() {
            document.getElementById('quiz-results-container').style.display = 'none';
            document.getElementById('quiz-question-nav').style.display = 'none';
            document.getElementById('quiz-questions-wrapper').style.display = 'none';

            let correctCount = 0;
            let reviewHTML = '<div class="quiz-review-container">';

            quizQuestions.forEach((q, idx) => {
                const userAnswer = quizSelectedAnswers[idx];
                const isCorrect = userAnswer === q.correct;
                const cardClass = isCorrect ? 'correct' : 'incorrect';

                if (isCorrect) correctCount++;

                reviewHTML += `
            <div class="quiz-review-card ${cardClass}">
                <div class="quiz-review-question-header">
                    <div class="quiz-review-status-badge ${cardClass}">
                        ${isCorrect ? '‚úì' : '‚úï'}
                    </div>
                    <div class="quiz-review-question-text">
                        ${idx + 1}. ${q.question}
                    </div>
                </div>
                
                <div class="quiz-review-options">
        `;

                Object.entries(q.options).forEach(([letter, option]) => {
                    const isUserSelected = userAnswer === letter;
                    const isCorrectAnswer = letter === q.correct;

                    let optionClass = 'quiz-review-option';
                    let indicator = '';

                    if (isCorrectAnswer) {
                        optionClass += ' correct';
                        indicator = '‚úì Correct Answer';
                    } else if (isUserSelected && !isCorrect) {
                        optionClass += ' incorrect';
                        indicator = '‚úï Your Answer';
                    }

                    if (isUserSelected || isCorrectAnswer) {
                        reviewHTML += `
                    <div class="${optionClass}">
                        <span class="quiz-review-option-label">${letter}.</span>
                        <span>${option}</span>
                        <span class="quiz-option-indicator">${indicator}</span>
                    </div>
                `;
                    }
                });

                reviewHTML += `
                </div>
                <div class="quiz-review-explanation">
                    <div class="quiz-explanation-title">üìö Explanation</div>
                    <div class="quiz-explanation-text">${q.explanation}</div>
                </div>
            </div>
        `;
            });

            reviewHTML += '</div>';

            const resultsContainer = document.getElementById('quiz-results-container');
            resultsContainer.innerHTML = `
        <div class="quiz-results-container" style="flex-direction: column; width: 100%;">
            <div style="width: 100%; text-align: center; margin-bottom: 2rem;">
                <h2 class="gradient-text" style="font-size: 1.8rem; margin-bottom: 1rem;">Review Your Answers</h2>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 2rem; color: #10b981; font-weight: 700;">
                            ${correctCount}
                        </div>
                        <div style="color: var(--subtext-dark); font-size: 0.9rem;">Correct</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 2rem; color: #ef4444; font-weight: 700;">
                            ${quizQuestions.length - correctCount}
                        </div>
                        <div style="color: var(--subtext-dark); font-size: 0.9rem;">Incorrect</div>
                    </div>
                </div>
            </div>
            ${reviewHTML}
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: center;">
                <button class="secondary-button" onclick="backToQuizResults()" style="max-width: 200px;">
                    ‚Üê Back to Results
                </button>
                <button class="gradient-button" onclick="closeQuizModal()" style="max-width: 200px;">
                    Close Quiz
                </button>
            </div>
        </div>
    `;

            resultsContainer.style.display = 'flex';
        }

        function backToQuizResults() {
            submitQuizAnswers();
        }

        function closeQuizModal() {
            const quizModal = document.getElementById('quiz-modal');
            closeModal(quizModal);

            // Complete reset of quiz state
            quizQuestions = [];
            quizSelectedAnswers = {};
            quizCurrentQuestion = 0;
            quizShowResults = false;

            // Reset all UI elements
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-content').classList.add('hidden');
            document.getElementById('quiz-nav-buttons').style.display = 'none';
            document.getElementById('quiz-questions-wrapper').style.display = 'block';
            document.getElementById('quiz-questions-wrapper').innerHTML = '';
            document.getElementById('quiz-question-nav').style.display = 'flex';
            document.getElementById('quiz-question-nav').innerHTML = '';
            document.getElementById('quiz-results-container').style.display = 'none';
            document.getElementById('quiz-results-container').innerHTML = '';
        }
    </script>
</body>

</html>
