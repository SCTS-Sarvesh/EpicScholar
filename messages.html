<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <title>Educational Messages</title>
    <link rel="stylesheet" href="messages.css">
    <style>
        /* Like count badge */
        .like-count {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 30px;
            text-align: center;
        }

        /* Comment button */
        .story-comment-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }

        .story-comment-btn:hover {
            transform: scale(1.1);
            background: rgba(0, 114, 255, 0.3);
            border-color: var(--primary-color);
        }

        /* Comment Box Slide-up Panel */
        .story-comment-box {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            height: 60vh;
            max-height: 500px;
            background: linear-gradient(to top, rgba(10, 10, 10, 0.98), rgba(20, 20, 20, 0.95));
            backdrop-filter: blur(20px);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.8);
            z-index: 200;
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
        }

        .story-comment-box.active {
            bottom: 0;
        }

        .comment-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comment-box-header h4 {
            color: white;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .comment-box-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-box-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .comment-box-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .no-comments {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
            gap: 15px;
        }

        .no-comments i {
            font-size: 48px;
            opacity: 0.3;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            animation: slideInComment 0.3s ease;
        }

        @keyframes slideInComment {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .comment-username {
            font-weight: 700;
            font-size: 14px;
            color: white;
        }

        .comment-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .comment-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .comment-box-input-wrapper {
            padding: 20px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .comment-box-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .comment-box-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 114, 255, 0.2);
        }

        .comment-box-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .comment-box-send-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
        }

        .comment-box-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.6);
        }

        .comment-box-send-btn:active {
            transform: scale(0.95);
        }

        /* Remove old reply container styles - no longer needed */
        .story-reply-container {
            display: none;
        }

        /* Adjust story text position since no reply input at bottom */
        .story-text-content {
            position: absolute;
            bottom: 30px;
            left: 20px;
            right: 80px;
            pointer-events: none;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .story-comment-box {
                height: 70vh;
                max-height: none;
            }
        }

        /* Two-column layout for Add Story Form */
        .add-story-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            padding: 30px;
        }

        /* Left column - Story details */
        .form-left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Right column - YouTube search */
        .form-right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 600px;
            overflow: hidden;
        }

        /* Make form groups stack in left column */
        .add-story-form .form-group:nth-child(1),
        .add-story-form .form-group:nth-child(2),
        .add-story-form .form-group:nth-child(3) {
            grid-column: 1;
        }

        /* YouTube search in right column */
        .add-story-form .form-group:nth-child(4) {
            grid-column: 2;
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Make YouTube results container fill right column */
        .add-story-form .form-group:nth-child(4) .spotify-results {
            flex: 1;
            max-height: none;
            overflow-y: auto;
            margin-top: 15px;
        }

        /* Form actions span both columns at bottom */
        .form-actions {
            grid-column: 1 / -1;
            margin-top: 0;
        }

        /* Adjust modal width for two-column layout */
        .add-story-modal .story-modal-content {
            max-width: 900px;
            width: 95%;
        }

        /* YouTube search label styling */
        .form-group label {
            position: sticky;
            top: 0;
            background: rgba(20, 20, 20, 0.95);
            z-index: 10;
            padding-bottom: 8px;
        }

        /* Enhanced YouTube search container */
        .youtube-search-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .youtube-search-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .youtube-search-input-wrapper input {
            flex: 1;
        }

        /* Time range selector in right column */
        #timeRangeSelector {
            margin-top: 15px;
            animation: slideInUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .add-story-form {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .add-story-form .form-group:nth-child(1),
            .add-story-form .form-group:nth-child(2),
            .add-story-form .form-group:nth-child(3),
            .add-story-form .form-group:nth-child(4) {
                grid-column: 1;
                grid-row: auto;
            }

            .form-right-column {
                max-height: 400px;
            }
        }

        /* Fix z-index layering for story interactions */
        .story-reply-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 90px;
            z-index: 100;
            /* Increased from 50 to be above navigation */
        }

        .story-interactions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 100;
            /* Increased from 50 to be above navigation */
            align-items: center;
        }

        /* Navigation areas should be below interactions */
        .story-nav-area {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 35%;
            z-index: 15;
            /* Keep this lower than interactions */
            cursor: pointer;
            transition: background 0.2s;
        }

        /* Ensure close button stays on top */
        .story-close {
            z-index: 150;
            /* Higher than everything */
        }

        /* Ensure progress bars stay on top */
        .story-progress-container {
            z-index: 120;
        }

        /* Ensure header stays on top */
        .story-header-info {
            z-index: 110;
        }

        /* Make reply input more visible and clickable */
        .story-reply-input-wrapper {
            position: relative;
            width: 100%;
            z-index: 100;
        }

        .story-reply-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 45px 12px 20px;
            color: white;
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            pointer-events: auto;
            /* Ensure it's clickable */
        }

        .story-reply-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 114, 255, 0.2);
        }

        .story-reply-btn {
            pointer-events: auto;
            /* Ensure button is clickable */
        }

        /* Ensure like button is clickable */
        .story-like-btn {
            pointer-events: auto;
            cursor: pointer;
        }

        /* Hide navigation arrows */
        .story-nav-arrows,
        .story-arrow,
        .arrow-left,
        .arrow-right {
            display: none !important;
        }

        /* Smooth cursor feedback */
        .story-carousel-container {
            cursor: grab;
            user-select: none;
        }

        .story-carousel-container:active {
            cursor: grabbing;
        }

        /* Visual hint for navigation */
        .story-navigation-hint {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            z-index: 25;
            display: flex;
            gap: 15px;
            align-items: center;
            animation: fadeInHint 0.5s ease 1s forwards;
            opacity: 0;
        }

        @keyframes fadeInHint {
            to {
                opacity: 1;
            }
        }

        .nav-hint-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-hint-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 10px;
        }

        .story-nav-area,
        .story-nav-left,
        .story-nav-right {
            display: none !important;
            pointer-events: none !important;
        }

        /* Ensure interactive elements are clickable */
        .story-interactions,
        .story-interactions *,
        .story-comment-box,
        .story-comment-box * {
            pointer-events: auto !important;
        }

        /* Prevent clicks on story background from navigating */
        .story-card {
            pointer-events: none;
        }

        .story-card.active {
            pointer-events: auto;
        }

        /* Allow clicks on interactive elements */
        .story-like-btn,
        .story-comment-btn,
        .comment-box-input,
        .comment-box-send-btn,
        .comment-box-close,
        .story-close {
            pointer-events: auto !important;
            cursor: pointer;
        }

        /* Add to your <style> section */
        .story-like-btn,
        .story-comment-btn {
            pointer-events: auto !important;
            cursor: pointer;
            z-index: 100;
            position: relative;
        }

        .story-comment-box * {
            pointer-events: auto !important;
        }

        /* Prevent clicks on story background */
        .story-card * {
            pointer-events: none;
        }

        .story-card.active .story-like-btn,
        .story-card.active .story-comment-btn,
        .story-card.active .story-comment-box,
        .story-card.active .story-comment-box * {
            pointer-events: auto !important;
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
    <div id="liquid-glass-container">
        <div class="glass-blob blob-1"></div>
        <div class="glass-blob blob-2"></div>
        <div class="glass-blob blob-3"></div>
    </div>

    <!-- Sidebar -->
    <!-- Sidebar -->
    <div class="nav-sidebar glass-element" id="navSidebar">
        <div class="nav-wrap" id="navWrap">
            <a class="nav-item" href="home.html" data-icon="üè†">
                <span class="nav-icon-generic">üè† </span>
                <span class="nav-text"> Home</span>
            </a>
            <a class="nav-item nav-item-active" href="messages.html" data-icon="‚úâÔ∏è">
                <span class="nav-icon-generic">‚úâÔ∏è </span>
                <span class="nav-text"> Messages</span>
            </a>
            <a class="nav-item" href="self-study.html" data-icon="üìñ">
                <span class="nav-icon-generic">üìñ </span>
                <span class="nav-text"> Self-Study</span>
            </a>
            <a class="nav-item" href="edubot.html" data-icon="ü§ñ">
                <span class="nav-icon-generic">ü§ñ </span>
                <span class="nav-text"> EduBot</span>
            </a>
            <a class="nav-item" href="mini-games.html" data-icon="üéÆ">
                <span class="nav-icon-generic">üéÆ </span>
                <span class="nav-text"> Mini-Games</span>
            </a>
        </div>

        <div class="settings-wrap">
            <a class="nav-item" href="profile.html" data-icon="üë§">
                <span class="nav-icon-generic">üë§</span>
                <span class="nav-text">Profile</span>
            </a>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container">
        <!-- Chat List Section -->
        <div class="chat-list-section glass-element">
            <div class="stories-container">
                <div class="stories-header">
                    <h3>Educational Stories</h3>
                    <button class="add-story-btn" onclick="openAddStoryModal()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="stories-list" id="storiesList"></div>
            </div>

            <div class="chat-list">
                <div class="chat-list-header">
                    <h2>Messages</h2>
                </div>
                <div class="conversations" id="conversationsList"></div>
            </div>
        </div>

        <!-- Chat Window Section -->
        <div class="chat-window-section">
            <div class="no-chat-selected glass-element" id="noChatSelected">
                <div class="no-chat-content">
                    <h2>Select a conversation</h2>
                    <p>Choose a chat to start messaging</p>
                </div>
            </div>

            <div class="chat-window glass-element hidden" id="chatWindow">
                <div class="chat-header" id="chatHeader"></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <div class="disappearing-options hidden" id="disappearingOptions">
                        <button class="option-btn" id="readOnceBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Read Once
                        </button>
                        <button class="option-btn" id="timedBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            24 Hours
                        </button>
                    </div>

                    <div class="chat-input">
                        <button class="input-btn" id="disappearingBtn" title="Disappearing messages">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </button>

                        <div id="normalInput">
                            <input type="text" id="messageInput" placeholder="Type a message..." />
                        </div>

                        <div class="recording-indicator hidden" id="recordingIndicator">
                            <span class="recording-dot"></span>
                            <span>Recording...</span>
                        </div>

                        <button class="input-btn" id="micBtn" title="Record voice message">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>

                        <button class="input-btn hidden" id="stopBtn" title="Stop recording">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                        </button>

                        <button class="input-btn send-btn hidden" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Story Modal -->
    <!-- Story View Modal -->
    <div class="story-modal" id="storyModal">
        <button class="story-close" onclick="closeStory()">√ó</button>
        <div class="story-modal-content">
            <!-- Carousel Container -->
            <div class="story-carousel-container" id="storyCarousel">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div class="story-modal add-story-modal" id="addStoryModal">
        <div class="story-modal-content modal-classic">
            <div class="story-header-info" style="border:none; padding:20px; padding-bottom:0;">
                <h4 style="color:white;">Create New Story</h4>
                <button class="story-close" onclick="closeAddStoryModal()"
                    style="position:absolute; right:20px; top:20px;">√ó</button>
            </div>
            <form class="add-story-form" onsubmit="submitStory(event)">
                <div class="form-group">
                    <label>Story Subject</label>
                    <input type="text" id="storySubject" placeholder="e.g., Math Tips" required />
                </div>

                <div class="form-group">
                    <label>Content</label>
                    <textarea id="storyContent" placeholder="Share your knowledge..." rows="4" required></textarea>
                </div>

                <!-- Media Upload Section -->
                <div class="form-group">
                    <label>Add Media (Optional)</label>
                    <div class="media-upload-container">
                        <input type="file" id="mediaUpload" accept="image/*,video/*" style="display:none;"
                            onchange="handleMediaUpload(event)" />
                        <button type="button" class="media-upload-btn"
                            onclick="document.getElementById('mediaUpload').click()">
                            <i class="fas fa-camera"></i> Upload Photo/Video
                        </button>
                        <div id="mediaPreview" class="media-preview hidden"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Add YouTube Audio Clip (Optional)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="spotifySearchQuery" placeholder="Search for a song or video..." />
                        <button type="button" class="spotify-search-btn"
                            onclick="setupLiveYouTubeSearch(); performLiveYouTubeSearch(document.getElementById('spotifySearchQuery').value)">
                            <i class="fab fa-youtube"></i> Search
                        </button>
                    </div>
                    <div class="youtube-audio-note">
                        <i class="fas fa-info-circle"></i> You'll be able to select a specific time range after choosing
                        a video
                    </div>
                </div>

                <div id="spotifyResults" class="spotify-results hidden"></div>
                <input type="hidden" id="selectedTrackData" />
                <input type="hidden" id="uploadedMediaData" />

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddStoryModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Post Story</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden Spotify Config for Demo -->
    <div style="display:none;">
        <input type="hidden" id="spotifyClientId" value="your_client_id_here" />
        <input type="hidden" id="spotifyClientSecret" value="your_client_secret_here" />
    </div>

    <script>
        // YouTube API Configuration
        const YOUTUBE_API_KEY = 'AIzaSyBiVCOrKMTbh1gVEpevbbJ_5EDewv7q_dI';

        // Mock Data
        const mockUsers = [
            { id: 1, name: "Sarah Chen", avatar: "https://i.pravatar.cc/150?img=1", online: true },
            { id: 2, name: "Mike Johnson", avatar: "https://i.pravatar.cc/150?img=2", online: false },
            { id: 3, name: "Emily Davis", avatar: "https://i.pravatar.cc/150?img=3", online: true },
            { id: 4, name: "David Lee", avatar: "https://i.pravatar.cc/150?img=4", online: false },
            { id: 5, name: "Anna Martinez", avatar: "https://i.pravatar.cc/150?img=5", online: true },
            { id: 'me', name: "You", avatar: "https://i.pravatar.cc/150?img=11", online: true }
        ];

        const mockConversations = [
            { id: 1, userId: 1, userName: "Sarah Chen", avatar: "https://i.pravatar.cc/150?img=1", lastMessage: "Hey! Did you finish the math assignment?", timestamp: new Date(Date.now() - 5 * 60000), unread: 2, online: true },
            { id: 2, userId: 2, userName: "Mike Johnson", avatar: "https://i.pravatar.cc/150?img=2", lastMessage: "Thanks for the study notes!", timestamp: new Date(Date.now() - 30 * 60000), unread: 0, online: false },
            { id: 3, userId: 3, userName: "Emily Davis", avatar: "https://i.pravatar.cc/150?img=3", lastMessage: "Can you help me with physics?", timestamp: new Date(Date.now() - 2 * 60 * 60000), unread: 1, online: true },
            { id: 4, userId: 4, userName: "David Lee", avatar: "https://i.pravatar.cc/150?img=4", lastMessage: "See you in class tomorrow!", timestamp: new Date(Date.now() - 24 * 60 * 60000), unread: 0, online: false },
            { id: 5, userId: 5, userName: "Anna Martinez", avatar: "https://i.pravatar.cc/150?img=5", lastMessage: "The biology project looks great!", timestamp: new Date(Date.now() - 48 * 60 * 60000), unread: 0, online: true }
        ];

        const mockMessages = {
            1: [{ id: 1, senderId: 1, text: "Hi! How are you doing?", timestamp: new Date(Date.now() - 60 * 60000), type: "text" }, { id: 2, senderId: "me", text: "I'm good! Working on the assignment.", timestamp: new Date(Date.now() - 55 * 60000), type: "text" }, { id: 3, senderId: 1, text: "Which one? The math homework?", timestamp: new Date(Date.now() - 50 * 60000), type: "text" }, { id: 4, senderId: "me", text: "Yes, the calculus problems.", timestamp: new Date(Date.now() - 45 * 60000), type: "text" }, { id: 5, senderId: 1, text: "Hey! Did you finish the math assignment?", timestamp: new Date(Date.now() - 5 * 60000), type: "text" }],
            2: [{ id: 8, senderId: 2, text: "Hey, do you have the notes from yesterday?", timestamp: new Date(Date.now() - 120 * 60000), type: "text" }, { id: 9, senderId: "me", text: "Sure, let me share them with you.", timestamp: new Date(Date.now() - 110 * 60000), type: "text" }, { id: 10, senderId: "me", text: "Here are the notes üìö", timestamp: new Date(Date.now() - 100 * 60000), type: "text" }, { id: 11, senderId: 2, text: "Thanks for the study notes!", timestamp: new Date(Date.now() - 30 * 60000), type: "text" }],
            3: [{ id: 12, senderId: 3, text: "I'm struggling with the physics chapter.", timestamp: new Date(Date.now() - 150 * 60000), type: "text" }, { id: 13, senderId: "me", text: "Which topic specifically?", timestamp: new Date(Date.now() - 140 * 60000), type: "text" }, { id: 14, senderId: 3, text: "Thermodynamics and heat transfer.", timestamp: new Date(Date.now() - 130 * 60000), type: "text" }, { id: 16, senderId: 3, text: "Can you help me with physics?", timestamp: new Date(Date.now() - 2 * 60 * 60000), type: "text" }],
            4: [{ id: 17, senderId: 4, text: "Want to study together this weekend?", timestamp: new Date(Date.now() - 30 * 60 * 60000), type: "text" }, { id: 18, senderId: "me", text: "Sure! Saturday afternoon?", timestamp: new Date(Date.now() - 29 * 60 * 60000), type: "text" }, { id: 19, senderId: 4, text: "Perfect! Library at 2 PM?", timestamp: new Date(Date.now() - 28 * 60 * 60000), type: "text" }, { id: 20, senderId: "me", text: "Sounds good! See you there.", timestamp: new Date(Date.now() - 27 * 60 * 60000), type: "text" }, { id: 21, senderId: 4, text: "See you in class tomorrow!", timestamp: new Date(Date.now() - 24 * 60 * 60000), type: "text" }],
            5: [{ id: 22, senderId: 5, text: "I finished my part of the project!", timestamp: new Date(Date.now() - 50 * 60 * 60000), type: "text" }, { id: 23, senderId: "me", text: "Awesome! Let me check it out.", timestamp: new Date(Date.now() - 49 * 60 * 60000), type: "text" }, { id: 24, senderId: "me", text: "The biology project looks great!", timestamp: new Date(Date.now() - 48 * 60 * 60000), type: "text" }, { id: 25, senderId: 5, text: "Thanks! üòä", timestamp: new Date(Date.now() - 48 * 60 * 60000), type: "text" }]
        };

        const mockStories = [
            { id: 1, userId: 1, userName: "Sarah Chen", avatar: "https://i.pravatar.cc/150?img=1", content: "Quick tip: Use flashcards for memorizing formulas! üìù", subject: "Study Tips", image: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 2 * 60 * 60000), viewed: false, youtubeVideo: null },
            { id: 101, userId: 1, userName: "Sarah Chen", avatar: "https://i.pravatar.cc/150?img=1", content: "Also, drink plenty of water while studying! üíß", subject: "Health", image: "https://images.unsplash.com/photo-1548839140-29a749e1cf4d?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 1 * 60 * 60000), viewed: false, youtubeVideo: null },
            { id: 2, userId: 3, userName: "Emily Davis", avatar: "https://i.pravatar.cc/150?img=3", content: "Just learned an amazing physics trick for solving kinematics problems!", subject: "Physics", image: "https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 5 * 60 * 60000), viewed: false, youtubeVideo: null },
            { id: 3, userId: 5, userName: "Anna Martinez", avatar: "https://i.pravatar.cc/150?img=5", content: "Biology hack: Use mnemonics to remember the Krebs cycle steps.", subject: "Biology", image: "https://images.unsplash.com/photo-1532094349884-543bc11b234d?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 8 * 60 * 60000), viewed: true, youtubeVideo: null },
            { id: 301, userId: 5, userName: "Anna Martinez", avatar: "https://i.pravatar.cc/150?img=5", content: "Look at these cells under the microscope! üî¨", subject: "Lab", image: "https://images.unsplash.com/photo-1576086213369-97a306d36557?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 7 * 60 * 60000), viewed: true, youtubeVideo: null },
            { id: 4, userId: 2, userName: "Mike Johnson", avatar: "https://i.pravatar.cc/150?img=2", content: "Found a great online resource for calculus practice problems!", subject: "Math", image: "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&w=400&q=80", timestamp: new Date(Date.now() - 12 * 60 * 60000), viewed: false, youtubeVideo: null }
        ];
        // Enhanced touch/swipe navigation
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartTime = 0;
        let isDragging = false;

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartTime = Date.now();
        }

        function handleTouchMove(e) {
            touchEndX = e.changedTouches[0].screenX;
        }

        function handleTouchEnd() {
            const touchDiff = touchStartX - touchEndX;
            const touchDuration = Date.now() - touchStartTime;
            const velocity = Math.abs(touchDiff) / touchDuration;

            // Minimum swipe distance (50px) or fast swipe (velocity)
            if (Math.abs(touchDiff) > 50 || velocity > 0.5) {
                if (touchDiff > 0) {
                    // Swipe left -> Next story
                    nextStory();
                } else {
                    // Swipe right -> Previous story
                    prevStory();
                }
            }

            touchStartX = 0;
            touchEndX = 0;
        }

        // Mouse drag navigation for desktop
        function handleMouseDown(e) {
            isDragging = true;
            touchStartX = e.screenX;
            touchStartTime = Date.now();
            e.currentTarget.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (isDragging) {
                touchEndX = e.screenX;
            }
        }

        function handleMouseUp(e) {
            if (isDragging) {
                const touchDiff = touchStartX - touchEndX;
                const touchDuration = Date.now() - touchStartTime;
                const velocity = Math.abs(touchDiff) / touchDuration;

                if (Math.abs(touchDiff) > 50 || velocity > 0.5) {
                    if (touchDiff > 0) {
                        nextStory();
                    } else {
                        prevStory();
                    }
                }

                isDragging = false;
                e.currentTarget.style.cursor = 'grab';
                touchStartX = 0;
                touchEndX = 0;
            }
        }

        function handleMouseLeave(e) {
            if (isDragging) {
                isDragging = false;
                e.currentTarget.style.cursor = 'grab';
            }
        }
        let conversations = [...mockConversations];
        let messages = JSON.parse(JSON.stringify(mockMessages));
        let stories = [...mockStories];
        let selectedChat = null;
        let disappearingMode = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let storyQueue = [];
        let storyQueueIndex = 0;
        let storyTimer = null;
        let progressAnimationFrame = null;
        let searchTimeout;
        let currentSearchController = null;
        let selectedVideoForTimeRange = null;
        let currentYouTubePlayer = null;
        let audioProgressInterval = null;
        const STORY_DURATION = 30000; // Fixed 30 seconds for story display

        function openAddStoryModal() {
            const modal = document.getElementById('addStoryModal');
            modal.classList.remove('closing');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeAddStoryModal() {
            const modal = document.getElementById('addStoryModal');
            modal.classList.remove('active');
            modal.classList.add('closing');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('closing');
                document.getElementById('storySubject').value = '';
                document.getElementById('storyContent').value = '';
                document.getElementById('spotifySearchQuery').value = '';
                document.getElementById('selectedTrackData').value = '';
                document.getElementById('spotifyResults').classList.add('hidden');
                removeMedia();
                removeTimeRangeSelector();
            }, 450);
        }

        function submitStory(e) {
            e.preventDefault();
            const newStory = {
                id: Date.now(),
                userId: 'me',
                userName: 'You',
                avatar: 'https://i.pravatar.cc/150?img=11',
                content: document.getElementById('storyContent').value,
                subject: document.getElementById('storySubject').value,
                timestamp: new Date(),
                viewed: false,
                likes: 0,
                liked: false,
                youtubeVideo: document.getElementById('selectedTrackData').value ? JSON.parse(document.getElementById('selectedTrackData').value) : null,
                media: document.getElementById('uploadedMediaData').value ? JSON.parse(document.getElementById('uploadedMediaData').value) : null
            };
            stories.unshift(newStory);
            renderStories();
            closeAddStoryModal();
            removeMedia();
        }

        function openStory(userId) {
            // Convert userId to string for comparison
            const userIdStr = String(userId);
            const userStories = stories.filter(s => String(s.userId) === userIdStr);

            if (!userStories.length) return;

            let startStory = userStories.find(s => !s.viewed) || userStories[0];
            storyQueue = [...stories];
            storyQueueIndex = storyQueue.findIndex(s => s.id === startStory.id);
            if (storyQueueIndex === -1) storyQueueIndex = 0;

            const modal = document.getElementById('storyModal');
            modal.classList.add('active');
            modal.style.display = 'flex';

            // Add comment box if not exists
            addCommentBoxToModal();

            initCarousel();
            updateCarousel();
            startStoryTimer();
            initStoryNavigation();
            updateNavigationArrows();
        }

        function renderStoryCard(story) {
            let mediaHTML = '', audioHTML = '';
            if (story.media) {
                mediaHTML = story.media.type === 'image'
                    ? `<div class="story-media-container"><img src="${story.media.data}" alt="Story media" /></div>`
                    : `<div class="story-media-container"><video src="${story.media.data}" controls playsinline></video></div>`;
            } else if (story.image) {
                mediaHTML = `<div class="story-media-container"><img src="${story.image}" alt="Story content" /></div>`;
            }

            if (story.youtubeVideo) {
                const { id, title, channel, thumbnail, startTime = 0, endTime = 30 } = story.youtubeVideo;
                const uniqueId = `youtube-player-${story.id}`;
                const duration = endTime - startTime;

                audioHTML = `
            <div class="story-audio-player">
                <div class="audio-track-info">
                    <div class="audio-details">
                        <div class="audio-title">${escapeHtml(title)}</div>
                    </div>
                </div>
                <div id="${uniqueId}" style="display:none;"></div>
            </div>
        `;
            }

            const likeBtnClass = story.liked ? 'liked' : '';
            const likeIcon = story.liked ? 'fas fa-heart' : 'far fa-heart';
            const likeCount = story.likes || 0;

            return `
        <div class="story-content-wrapper">
            <div class="story-header-info">
                <img src="${story.avatar}" alt="${story.userName}">
                <div class="user-info">
                    <h4>${story.userName}</h4>
                    <div class="story-timestamp">${formatTime(story.timestamp)}</div>
                </div>
            </div>
            ${mediaHTML}
            ${audioHTML}

            <div class="story-interactions">
                <div class="story-like-btn ${likeBtnClass}" onclick="toggleLike(${story.id}, event);">
                    <i class="${likeIcon}"></i>
                </div>
                ${likeCount > 0 ? `<div class="like-count">${likeCount}</div>` : ''}
                
                <button class="story-comment-btn" onclick="toggleCommentBox(${story.id}, event);">
                    <i class="fas fa-comment"></i>
                </button>
            </div>

            <div class="story-text-content">
                <span class="story-subject-badge">${story.subject}</span>
                <div class="story-text" style="font-size: 16px;">${story.content}</div>
            </div>
        </div>
    `;
        }
        function initCarousel() {
            const container = document.getElementById('storyCarousel');
            if (!container) return;
            container.innerHTML = '';

            // Progress bars
            const progressContainer = document.createElement('div');
            progressContainer.className = 'story-progress-container';
            progressContainer.innerHTML = storyQueue.map((_, i) =>
                `<div class="story-progress-bar">
            <div class="story-progress-fill" id="progress-${i}"></div>
        </div>`
            ).join('');
            container.appendChild(progressContainer);

            // Story cards
            storyQueue.forEach((story, idx) => {
                const el = document.createElement('div');
                el.className = 'story-card hidden-right';
                el.id = `story-card-${idx}`;
                el.innerHTML = renderStoryCard(story);
                container.appendChild(el);
            });
        }

        function nextStory() {
            // Safely destroy YouTube player
            if (currentYouTubePlayer) {
                try {
                    if (typeof currentYouTubePlayer.pauseVideo === 'function') {
                        currentYouTubePlayer.pauseVideo();
                    }
                    if (typeof currentYouTubePlayer.destroy === 'function') {
                        currentYouTubePlayer.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying player:', e);
                }
                currentYouTubePlayer = null;
            }

            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
                audioProgressInterval = null;
            }

            if (storyQueueIndex < storyQueue.length - 1) {
                storyQueueIndex++;
                updateCarousel();
                startStoryTimer();
                updateNavigationArrows();
            } else {
                closeStory();
            }
        }

        function prevStory() {
            // Safely destroy YouTube player
            if (currentYouTubePlayer) {
                try {
                    if (typeof currentYouTubePlayer.pauseVideo === 'function') {
                        currentYouTubePlayer.pauseVideo();
                    }
                    if (typeof currentYouTubePlayer.destroy === 'function') {
                        currentYouTubePlayer.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying player:', e);
                }
                currentYouTubePlayer = null;
            }

            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
                audioProgressInterval = null;
            }

            if (storyQueueIndex > 0) {
                storyQueueIndex--;
                updateCarousel();
                startStoryTimer();
                updateNavigationArrows();
            }
        }

        // Update sendStoryReply function
        function sendStoryReply(storyId, text) {
            if (!text || !text.trim()) return;

            const story = stories.find(s => s.id === storyId);
            if (!story) return;

            // Don't allow replying to your own story
            if (story.userId === 'me') {
                alert("You can't reply to your own story!");
                return;
            }

            const userId = story.userId;

            // Create new message
            const msg = {
                id: Date.now(),
                senderId: 'me',
                text: `Replied to story: ${text}`,
                storyRef: storyId,
                storyTitle: story.subject,
                type: 'text',
                timestamp: new Date()
            };

            if (!messages[userId]) messages[userId] = [];
            messages[userId].push(msg);

            // Update conversation list
            let conv = conversations.find(c => c.userId == userId);
            if (conv) {
                conv.lastMessage = `Replied to story: ${text}`;
                conv.timestamp = new Date();
                conv.unread = 0;
            } else {
                conversations.unshift({
                    id: userId,
                    userId: userId,
                    userName: story.userName,
                    avatar: story.avatar,
                    lastMessage: `Replied to story: ${text}`,
                    timestamp: new Date(),
                    unread: 0,
                    online: true
                });
            }

            // Clear input
            const input = document.querySelector('.story-card.active .story-reply-input');
            if (input) input.value = '';

            // Show feedback
            alert('Reply sent!');
        }

        function toggleLike(storyId, event) {
            // Prevent event from bubbling up
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const story = stories.find(s => s.id === storyId);
            if (!story) return;

            story.liked = !story.liked;
            story.likes = (story.likes || 0) + (story.liked ? 1 : -1);

            // Update UI in active card
            const activeCard = document.querySelector('.story-card.active');
            if (activeCard) {
                const likeBtn = activeCard.querySelector('.story-like-btn');
                if (likeBtn) {
                    likeBtn.classList.toggle('liked', story.liked);
                    const icon = likeBtn.querySelector('i');
                    if (icon) {
                        icon.className = story.liked ? 'fas fa-heart' : 'far fa-heart';
                    }
                }

                // Update like count
                const likeCountEl = activeCard.querySelector('.like-count');
                if (story.likes > 0) {
                    if (likeCountEl) {
                        likeCountEl.textContent = story.likes;
                    } else {
                        // Create like count if it doesn't exist
                        const interactions = activeCard.querySelector('.story-interactions');
                        const likeBtn = interactions.querySelector('.story-like-btn');
                        const countBadge = document.createElement('div');
                        countBadge.className = 'like-count';
                        countBadge.textContent = story.likes;
                        interactions.insertBefore(countBadge, likeBtn.nextSibling);
                    }
                } else if (likeCountEl) {
                    likeCountEl.remove();
                }
            }
        }

        // Remove the navigation areas from HTML and let JS handle them
        // Update the story modal HTML section to remove navigation divs
        // The initCarousel function now adds them dynamically

        function closeStory() {
            // Safely destroy YouTube player
            if (currentYouTubePlayer) {
                try {
                    if (typeof currentYouTubePlayer.pauseVideo === 'function') {
                        currentYouTubePlayer.pauseVideo();
                    }
                    if (typeof currentYouTubePlayer.destroy === 'function') {
                        currentYouTubePlayer.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying player:', e);
                }
                currentYouTubePlayer = null;
            }

            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
                audioProgressInterval = null;
            }

            // Close comment box
            closeCommentBox();

            document.getElementById('storyModal').classList.remove('active');
            document.getElementById('storyModal').style.display = 'none';
            clearTimeout(storyTimer);
            if (progressAnimationFrame) cancelAnimationFrame(progressAnimationFrame);
            progressAnimationFrame = null;
            renderStories();
        }

        function toggleAudioPlayback(storyId) {
            if (!currentYouTubePlayer) return;

            try {
                const btn = document.getElementById(`playPauseBtn-${storyId}`);
                const icon = btn ? btn.querySelector('i') : null;

                if (typeof currentYouTubePlayer.getPlayerState !== 'function') return;

                const state = currentYouTubePlayer.getPlayerState();

                if (state === 1) { // Playing
                    if (typeof currentYouTubePlayer.pauseVideo === 'function') {
                        currentYouTubePlayer.pauseVideo();
                    }
                    if (icon) icon.className = 'fas fa-play';
                } else { // Paused or not started
                    if (typeof currentYouTubePlayer.playVideo === 'function') {
                        currentYouTubePlayer.playVideo();
                    }
                    if (icon) icon.className = 'fas fa-pause';
                }
            } catch (e) {
                console.log('Error toggling playback:', e);
            }
        }

        function setVolume(storyId, volume) {
            if (!currentYouTubePlayer) return;

            try {
                if (typeof currentYouTubePlayer.setVolume === 'function') {
                    currentYouTubePlayer.setVolume(volume);
                }
            } catch (e) {
                console.log('Error setting volume:', e);
            }
        }

        function updateAudioProgress(storyId, currentTime, duration) {
            const progressBar = document.getElementById(`audioProgress-${storyId}`);
            const currentTimeDisplay = document.getElementById(`audioCurrentTime-${storyId}`);

            if (progressBar && currentTimeDisplay) {
                const percentage = (currentTime / duration) * 100;
                progressBar.style.width = `${percentage}%`;
                currentTimeDisplay.textContent = formatSeconds(Math.floor(currentTime));
            }
        }

        function initCarousel() {
            const container = document.getElementById('storyCarousel');
            if (!container) return;
            container.innerHTML = '';

            // Progress bars
            const progressContainer = document.createElement('div');
            progressContainer.className = 'story-progress-container';
            progressContainer.innerHTML = storyQueue.map((_, i) => `<div class="story-progress-bar"><div class="story-progress-fill" id="progress-${i}"></div></div>`).join('');
            container.appendChild(progressContainer);

            // Story cards
            storyQueue.forEach((story, idx) => {
                const el = document.createElement('div');
                el.className = 'story-card hidden-right';
                el.id = `story-card-${idx}`;
                el.innerHTML = renderStoryCard(story);
                container.appendChild(el);
            });

            // NO navigation areas - only swipe/scroll
        }

        function updateProgressBars() {
            storyQueue.forEach((_, idx) => {
                const fill = document.getElementById(`progress-${idx}`);
                if (!fill) return;
                fill.classList.remove('active', 'completed');
                fill.style.width = '0%';
                if (idx < storyQueueIndex) {
                    fill.classList.add('completed');
                    fill.style.width = '100%';
                } else if (idx === storyQueueIndex) {
                    fill.classList.add('active');
                    animateProgress(fill, STORY_DURATION);
                }
            });
        }

        function animateProgress(el, dur) {
            let start = null;
            const animate = (ts) => {
                if (!start) start = ts;
                const prog = (ts - start) / dur;
                el.style.width = `${Math.min(prog * 100, 100)}%`;
                if (prog < 1 && document.getElementById('storyModal').classList.contains('active')) {
                    progressAnimationFrame = requestAnimationFrame(animate);
                }
            };
            progressAnimationFrame = requestAnimationFrame(animate);
        }

        function updateCarousel() {
            const story = storyQueue[storyQueueIndex];
            if (story) {
                story.viewed = true;
                stories = stories.map(s => s.id === story.id ? { ...s, viewed: true } : s);
            }

            storyQueue.forEach((_, idx) => {
                const el = document.getElementById(`story-card-${idx}`);
                if (!el) return;
                el.className = 'story-card';
                if (idx === storyQueueIndex) el.classList.add('active');
                else if (idx === storyQueueIndex - 1) el.classList.add('prev');
                else if (idx === storyQueueIndex + 1) el.classList.add('next');
                else if (idx < storyQueueIndex) el.classList.add('hidden-left');
                else el.classList.add('hidden-right');
            });

            updateProgressBars();

            // Initialize YouTube player if story has video
            if (story && story.youtubeVideo) {
                initYouTubePlayer(story);
            }
        }

        function initYouTubePlayer(story) {
            const { id, startTime = 0, endTime = 30 } = story.youtubeVideo;
            const playerId = `youtube-player-${story.id}`;
            const clipDuration = endTime - startTime;

            setTimeout(() => {
                if (typeof YT !== 'undefined' && YT.Player) {
                    try {
                        currentYouTubePlayer = new YT.Player(playerId, {
                            height: '0',
                            width: '0',
                            videoId: id,
                            playerVars: {
                                autoplay: 1,
                                controls: 0,
                                start: startTime,
                                end: endTime,
                                modestbranding: 1,
                                rel: 0
                            },
                            events: {
                                onReady: (event) => {
                                    try {
                                        event.target.setVolume(80);
                                        event.target.playVideo();

                                        const btn = document.getElementById(`playPauseBtn-${story.id}`);
                                        if (btn) {
                                            const icon = btn.querySelector('i');
                                            if (icon) icon.className = 'fas fa-play';
                                        }
                                    } catch (e) {
                                        console.log('Error in onReady:', e);
                                    }
                                },
                                onStateChange: (event) => {
                                    try {
                                        const btn = document.getElementById(`playPauseBtn-${story.id}`);
                                        const icon = btn ? btn.querySelector('i') : null;

                                        if (event.data === YT.PlayerState.PLAYING) {
                                            if (icon) icon.className = 'fas fa-pause';

                                            if (audioProgressInterval) clearInterval(audioProgressInterval);
                                            audioProgressInterval = setInterval(() => {
                                                if (currentYouTubePlayer && typeof currentYouTubePlayer.getCurrentTime === 'function') {
                                                    const currentTime = currentYouTubePlayer.getCurrentTime() - startTime;
                                                    updateAudioProgress(story.id, currentTime, clipDuration);
                                                }
                                            }, 100);
                                        } else if (event.data === YT.PlayerState.PAUSED) {
                                            if (icon) icon.className = 'fas fa-play';
                                            if (audioProgressInterval) clearInterval(audioProgressInterval);
                                        } else if (event.data === YT.PlayerState.ENDED) {
                                            if (icon) icon.className = 'fas fa-play';
                                            if (audioProgressInterval) clearInterval(audioProgressInterval);
                                            event.target.seekTo(startTime);
                                            updateAudioProgress(story.id, 0, clipDuration);
                                        }
                                    } catch (e) {
                                        console.log('Error in onStateChange:', e);
                                    }
                                }
                            }
                        });
                    } catch (e) {
                        console.log('Error creating YouTube player:', e);
                        currentYouTubePlayer = null;
                    }
                }
            }, 100);
        }

        function startStoryTimer() {
            clearTimeout(storyTimer);
            if (progressAnimationFrame) cancelAnimationFrame(progressAnimationFrame);
            storyTimer = setTimeout(nextStory, STORY_DURATION);
        }
        function initStoryNavigation() {
            const carousel = document.getElementById('storyCarousel');
            if (!carousel) return;

            // Remove old listeners
            carousel.removeEventListener('touchstart', handleTouchStart);
            carousel.removeEventListener('touchmove', handleTouchMove);
            carousel.removeEventListener('touchend', handleTouchEnd);
            carousel.removeEventListener('mousedown', handleMouseDown);
            carousel.removeEventListener('mousemove', handleMouseMove);
            carousel.removeEventListener('mouseup', handleMouseUp);
            carousel.removeEventListener('mouseleave', handleMouseLeave);

            // Add only swipe/drag listeners (no click)
            carousel.addEventListener('touchstart', handleTouchStart, { passive: true });
            carousel.addEventListener('touchmove', handleTouchMove, { passive: true });
            carousel.addEventListener('touchend', handleTouchEnd, { passive: true });
            carousel.addEventListener('mousedown', handleMouseDown);
            carousel.addEventListener('mousemove', handleMouseMove);
            carousel.addEventListener('mouseup', handleMouseUp);
            carousel.addEventListener('mouseleave', handleMouseLeave);

            // Set cursor style
            carousel.style.cursor = 'default'; // Changed from 'grab'
        }
        function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
        function handleTouchMove(e) { touchEndX = e.changedTouches[0].screenX; }
        function handleTouchEnd() { handleSwipe(); }
        function handleMouseDown(e) { isDragging = true; touchStartX = e.screenX; e.currentTarget.style.cursor = 'grabbing'; }
        function handleMouseMove(e) { if (isDragging) touchEndX = e.screenX; }
        function handleMouseUp(e) { if (isDragging) { isDragging = false; e.currentTarget.style.cursor = 'grab'; handleSwipe(); } }
        function handleMouseLeave(e) { if (isDragging) { isDragging = false; e.currentTarget.style.cursor = 'grab'; } }
        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) diff > 0 ? nextStory() : prevStory();
            touchStartX = 0; touchEndX = 0;
        }
        // Enhanced keyboard navigation with smooth transitions
        function handleKeyPress(e) {
            const modal = document.getElementById('storyModal');
            if (!modal || modal.style.display !== 'flex') return;

            // Prevent default arrow key scrolling
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
            }

            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                prevStory();
            } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                nextStory();
            } else if (e.key === 'Escape') {
                closeStory();
            }
        }
        // Trackpad/Mouse Wheel Navigation
        let wheelTimeout;
        let isWheeling = false;

        function handleWheelNavigation(e) {
            const modal = document.getElementById('storyModal');
            if (!modal || modal.style.display !== 'flex') return;

            // Prevent default scrolling
            e.preventDefault();

            // Debounce to prevent too many rapid changes
            if (isWheeling) return;

            const deltaX = e.deltaX;
            const deltaY = e.deltaY;

            // Determine if it's horizontal or vertical scroll
            const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
            const scrollAmount = isHorizontal ? deltaX : deltaY;

            // Threshold to trigger navigation (adjust sensitivity here)
            const threshold = 30;

            if (Math.abs(scrollAmount) > threshold) {
                isWheeling = true;

                if (scrollAmount > 0) {
                    // Scroll right/down -> Next story
                    nextStory();
                } else {
                    // Scroll left/up -> Previous story
                    prevStory();
                }

                // Reset wheeling flag after delay
                clearTimeout(wheelTimeout);
                wheelTimeout = setTimeout(() => {
                    isWheeling = false;
                }, 600); // Adjust delay between transitions
            }
        }

        // Add wheel listener to story modal
        function initWheelNavigation() {
            const modal = document.getElementById('storyModal');
            if (modal) {
                modal.addEventListener('wheel', handleWheelNavigation, { passive: false });
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initWheelNavigation();
            // ... your existing DOMContentLoaded code
        });
        // Register keyboard listener
        document.addEventListener('keydown', handleKeyPress);

        function updateNavigationArrows() {
            const left = document.querySelector('.arrow-left');
            const right = document.querySelector('.arrow-right');
            if (left && right) {
                storyQueueIndex === 0 ? left.classList.add('disabled') : left.classList.remove('disabled');
                storyQueueIndex === storyQueue.length - 1 ? right.classList.add('disabled') : right.classList.remove('disabled');
            }
        }

        function setupLiveYouTubeSearch() {
            document.getElementById('spotifySearchQuery').addEventListener('input', function (e) {
                const query = e.target.value.trim();
                clearTimeout(searchTimeout);
                if (currentSearchController) currentSearchController.abort();
                if (query.length < 2) {
                    document.getElementById('spotifyResults').classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(() => performLiveYouTubeSearch(query), 500);
            });
        }

        async function performLiveYouTubeSearch(query) {
            const results = document.getElementById('spotifyResults');
            results.classList.remove('hidden');
            results.innerHTML = '<div style="padding:20px;text-align:center;"><div style="width:40px;height:40px;border:4px solid rgba(255,255,255,0.1);border-top-color:#FF0000;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div></div>';
            currentSearchController = new AbortController();

            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoCategoryId=10&maxResults=8&key=${YOUTUBE_API_KEY}`, { signal: currentSearchController.signal });
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const ids = data.items.map(i => i.id.videoId).join(',');
                const durRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${ids}&key=${YOUTUBE_API_KEY}`, { signal: currentSearchController.signal });
                const durData = await durRes.json();
                const durs = {};
                durData.items.forEach(i => durs[i.id] = formatDuration(i.contentDetails.duration));

                results.innerHTML = '';
                if (data.items?.length) {
                    data.items.forEach(v => {
                        const el = document.createElement('div');
                        el.className = 'spotify-track-item';
                        el.onclick = () => selectYouTubeVideoEnhanced(v, el, durs[v.id.videoId]);
                        const dur = durs[v.id.videoId] || '...';
                        el.innerHTML = `<div class="track-icon"><i class="fab fa-youtube"></i></div><div class="track-info"><div class="track-title">${escapeHtml(v.snippet.title)}</div><div class="track-artist"><i class="fas fa-user" style="font-size:10px;"></i> ${escapeHtml(v.snippet.channelTitle)}${dur !== '...' ? ` <span class="track-duration">‚Ä¢ ${dur}</span>` : ''}</div></div><div class="track-check"><i class="fas fa-check"></i></div>`;
                        results.appendChild(el);
                    });
                } else {
                    results.innerHTML = '<div style="padding:40px 20px;text-align:center;color:rgba(255,255,255,0.5);"><i class="fas fa-search" style="font-size:48px;margin-bottom:15px;opacity:0.3;"></i><div>No videos found</div><div style="font-size:12px;margin-top:5px;">Try different keywords</div></div>';
                }
            } catch (err) {
                if (err.name === 'AbortError') return;
                results.innerHTML = '<div style="padding:40px 20px;text-align:center;"><i class="fas fa-exclamation-triangle" style="font-size:48px;color:#ff6b6b;margin-bottom:15px;"></i><div style="color:#ff6b6b;">Search failed</div></div>';
            }
        }

        function selectYouTubeVideoEnhanced(video, el, duration) {
            document.querySelectorAll('.spotify-track-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');

            selectedVideoForTimeRange = {
                id: video.id.videoId,
                title: video.snippet.title,
                channel: video.snippet.channelTitle,
                thumbnail: video.snippet.thumbnails.medium.url,
                duration: duration
            };

            showTimeRangeSelector(selectedVideoForTimeRange);
        }

        function showTimeRangeSelector(video) {
            removeTimeRangeSelector();

            const totalSeconds = parseDurationToSeconds(video.duration);

            const selector = document.createElement('div');
            selector.className = 'time-range-selector';
            selector.id = 'timeRangeSelector';
            selector.innerHTML = `
        <div class="time-range-header">
            <h4><i class="fas fa-scissors"></i> Select Audio Clip</h4>
            <p>Choose up to 30 seconds from "${escapeHtml(video.title)}"</p>
        </div>
        
        <div class="time-inputs">
            <div class="time-input-group">
                <label>Start Time</label>
                <input type="number" id="startTimeInput" min="0" max="${totalSeconds - 1}" value="0" step="1" />
                <span class="time-unit">seconds</span>
            </div>
            <div class="time-input-group">
                <label>End Time</label>
                <input type="number" id="endTimeInput" min="1" max="${totalSeconds}" value="${Math.min(30, totalSeconds)}" step="1" />
                <span class="time-unit">seconds</span>
            </div>
        </div>
        
        <div class="time-presets">
            <button type="button" class="preset-btn" onclick="setPresetTime(0, 15)">First 15s</button>
            <button type="button" class="preset-btn" onclick="setPresetTime(0, 30)">First 30s</button>
            <button type="button" class="preset-btn" onclick="setPresetTime(${Math.max(0, totalSeconds - 30)}, ${totalSeconds})">Last 30s</button>
        </div>
        
        <div class="time-range-preview">
            <div class="preview-bar" id="timelinePreviewBar">
                <div class="preview-selection" id="previewSelection"></div>
            </div>
            <div class="preview-labels">
                <span>0:00</span>
                <span id="selectionLabel">0:00 - 0:30</span>
                <span>${video.duration}</span>
            </div>
        </div>

        <div class="preview-controls">
            <button type="button" class="btn-preview-audio" id="previewBtn" onclick="togglePreview()">
                <i class="fas fa-play"></i> Play Preview
            </button>
        </div>
        <div id="preview-player-container" style="display:none;"></div>
        
        <button type="button" class="btn-confirm-time" onclick="confirmTimeRange()">
            <i class="fas fa-check"></i> Confirm Selection
        </button>
    `;

            const form = document.querySelector('.add-story-form');
            const resultsDiv = document.getElementById('spotifyResults');
            form.insertBefore(selector, resultsDiv);

            const startInput = document.getElementById('startTimeInput');
            const endInput = document.getElementById('endTimeInput');

            startInput.addEventListener('input', updatePreview);
            endInput.addEventListener('input', updatePreview);

            updatePreview();

            // Add interactive timeline listeners
            const previewBar = document.getElementById('timelinePreviewBar');
            if (previewBar) {
                previewBar.addEventListener('mousedown', handleTimelineInteractionStart);
                document.addEventListener('mousemove', handleTimelineInteractionMove);
                document.addEventListener('mouseup', handleTimelineInteractionEnd);

                // Touch support
                previewBar.addEventListener('touchstart', handleTimelineInteractionStart, { passive: false });
                document.addEventListener('touchmove', handleTimelineInteractionMove, { passive: false });
                document.addEventListener('touchend', handleTimelineInteractionEnd);
            }
        }

        let isDraggingTimeline = false;
        let timelineDragMode = 'move'; // 'move' or 'resize' - simplified to just move/set for now

        function handleTimelineInteractionStart(e) {
            e.preventDefault(); // Prevent text selection
            isDraggingTimeline = true;
            handleTimelineInteractionMove(e);
        }

        function handleTimelineInteractionMove(e) {
            if (!isDraggingTimeline) return;

            // Handle both mouse and touch events
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;

            const previewBar = document.getElementById('timelinePreviewBar');
            if (!previewBar) return;

            const rect = previewBar.getBoundingClientRect();
            const totalSeconds = parseDurationToSeconds(selectedVideoForTimeRange.duration);

            // Calculate seconds based on position
            let clickPosition = (clientX - rect.left) / rect.width;
            clickPosition = Math.max(0, Math.min(1, clickPosition));

            let clickedSeconds = Math.round(clickPosition * totalSeconds);

            // Logic: Center the 30s selection around the clicked point, or move start to clicked point
            // For simplicity: Set start time to clicked point, ensuring we don't go out of bounds

            let start = clickedSeconds;
            let end = start + 30;

            // If end exceeds total, shift back
            if (end > totalSeconds) {
                end = totalSeconds;
                start = Math.max(0, end - 30);
            }

            document.getElementById('startTimeInput').value = start;
            document.getElementById('endTimeInput').value = end;
            updatePreview();
        }

        function handleTimelineInteractionEnd(e) {
            isDraggingTimeline = false;
        }

        function setPresetTime(start, end) {
            document.getElementById('startTimeInput').value = start;
            document.getElementById('endTimeInput').value = end;
            updatePreview();
        }

        function updatePreview() {
            const startInput = document.getElementById('startTimeInput');
            const endInput = document.getElementById('endTimeInput');
            const selection = document.getElementById('previewSelection');
            const label = document.getElementById('selectionLabel');

            if (!startInput || !endInput || !selection || !label) return;

            let start = parseInt(startInput.value) || 0;
            let end = parseInt(endInput.value) || 30;

            // Ensure end is after start
            if (end <= start) {
                end = start + 1;
                endInput.value = end;
            }

            // Ensure duration doesn't exceed 30 seconds
            if (end - start > 30) {
                end = start + 30;
                endInput.value = end;
            }

            const totalSeconds = parseDurationToSeconds(selectedVideoForTimeRange.duration);
            const startPercent = (start / totalSeconds) * 100;
            const endPercent = (end / totalSeconds) * 100;

            selection.style.left = `${startPercent}%`;
            selection.style.width = `${endPercent - startPercent}%`;

            label.textContent = `${formatSeconds(start)} - ${formatSeconds(end)} (${end - start}s)`;
        }

        function confirmTimeRange() {
            const start = parseInt(document.getElementById('startTimeInput').value) || 0;
            const end = parseInt(document.getElementById('endTimeInput').value) || 30;

            if (end - start > 30) {
                alert('Duration cannot exceed 30 seconds!');
                return;
            }

            if (end <= start) {
                alert('End time must be after start time!');
                return;
            }

            const trackData = {
                ...selectedVideoForTimeRange,
                startTime: start,
                endTime: end
            };

            document.getElementById('selectedTrackData').value = JSON.stringify(trackData);
            document.getElementById('spotifySearchQuery').value = selectedVideoForTimeRange.title;
            document.getElementById('spotifyResults').classList.add('hidden');
            removeTimeRangeSelector();
        }

        function removeTimeRangeSelector() {
            const selector = document.getElementById('timeRangeSelector');
            if (selector) selector.remove();

            document.removeEventListener('mousemove', handleTimelineInteractionMove);
            document.removeEventListener('mouseup', handleTimelineInteractionEnd);
            document.removeEventListener('touchmove', handleTimelineInteractionMove);
            document.removeEventListener('touchend', handleTimelineInteractionEnd);
        }

        function parseDurationToSeconds(duration) {
            if (!duration) return 0;
            const match = duration.match(/(\d+):(\d+)/);
            if (!match) return 0;
            const minutes = parseInt(match[1]);
            const seconds = parseInt(match[2]);
            return minutes * 60 + seconds;
        }

        function formatSeconds(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDuration(iso) {
            const m = iso.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const h = (m[1] || '').replace('H', ''), min = (m[2] || '').replace('M', ''), s = (m[3] || '').replace('S', '');
            return h ? `${h}:${min.padStart(2, '0')}:${s.padStart(2, '0')}` : `${min || '0'}:${s.padStart(2, '0')}`;
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        let uploadedMediaFile = null, uploadedMediaType = null;

        function handleMediaUpload(e) {
            const file = e.target.files[0];
            if (!file || file.size > 50 * 1024 * 1024) {
                if (file) alert('File too large!');
                return;
            }
            uploadedMediaFile = file;
            uploadedMediaType = file.type.startsWith('image/') ? 'image' : 'video';
            const reader = new FileReader();
            reader.onload = (ev) => {
                const preview = document.getElementById('mediaPreview');
                preview.classList.remove('hidden');
                preview.innerHTML = uploadedMediaType === 'image'
                    ? `<img src="${ev.target.result}" /><button type="button" class="media-remove-btn" onclick="removeMedia()">√ó</button><div class="media-info"><i class="fas fa-image"></i> Image</div>`
                    : `<video src="${ev.target.result}" controls></video><button type="button" class="media-remove-btn" onclick="removeMedia()">√ó</button><div class="media-info"><i class="fas fa-video"></i> Video</div>`;
                document.getElementById('uploadedMediaData').value = JSON.stringify({
                    type: uploadedMediaType,
                    data: ev.target.result,
                    name: file.name,
                    size: file.size
                });
            };
            reader.readAsDataURL(file);
        }

        function removeMedia() {
            uploadedMediaFile = null;
            uploadedMediaType = null;
            document.getElementById('mediaPreview').classList.add('hidden');
            document.getElementById('mediaPreview').innerHTML = '';
            document.getElementById('uploadedMediaData').value = '';
            document.getElementById('mediaUpload').value = '';
        }

        function formatTime(ts) {
            const diff = Date.now() - new Date(ts), m = Math.floor(diff / 60000), h = Math.floor(diff / 3600000), d = Math.floor(diff / 86400000);
            if (m < 1) return 'Just now';
            if (m < 60) return `${m}m ago`;
            if (h < 24) return `${h}h ago`;
            if (d === 1) return 'Yesterday';
            if (d < 7) return `${d}d ago`;
            return new Date(ts).toLocaleDateString();
        }

        function formatMessageTime(ts) {
            return new Date(ts).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function renderStories() {
            const storiesByUser = {};
            stories.forEach(s => {
                if (!storiesByUser[s.userId]) storiesByUser[s.userId] = {
                    user: { id: s.userId, name: s.userName, avatar: s.avatar },
                    stories: [],
                    allViewed: true
                };
                storiesByUser[s.userId].stories.push(s);
                if (!s.viewed) storiesByUser[s.userId].allViewed = false;
            });
            document.getElementById('storiesList').innerHTML = Object.values(storiesByUser).map(g => `
        <div class="story-item ${g.allViewed ? 'viewed' : ''}" onclick="openStory('${g.user.id}')">
            <div class="story-ring">
                <img src="${g.user.avatar}" />
                ${g.stories.length > 1 ? `<div class="story-count-badge">${g.stories.length}</div>` : ''}
            </div>
            <span class="story-username">${g.user.name.split(' ')[0]}</span>
        </div>
    `).join('');
        }

        function renderConversations() {
            document.getElementById('conversationsList').innerHTML = conversations.map(c => `
        <div class="conversation-item ${selectedChat === c.id ? 'active' : ''}" onclick="selectChat(${c.id})">
            <div class="conversation-avatar">
                <img src="${c.avatar}" />
                ${c.online ? '<div class="online-indicator"></div>' : ''}
            </div>
            <div class="conversation-content">
                <div class="conversation-header">
                    <span class="conversation-name">${c.userName}</span>
                    <span class="conversation-time">${formatTime(c.timestamp)}</span>
                </div>
                <div class="conversation-preview">
                    <span class="last-message">${c.lastMessage}</span>
                    ${c.unread > 0 ? `<span class="unread-badge">${c.unread}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
        }

        function renderChatHeader() {
            const c = conversations.find(x => x.id === selectedChat);
            if (!c) return;
            document.getElementById('chatHeader').innerHTML = `
        <div class="chat-header-user">
            <img src="${c.avatar}" />
            <div class="chat-header-info">
                <h3>${c.userName}</h3>
                <span class="status ${c.online ? 'online' : 'offline'}">${c.online ? 'Online' : 'Offline'}</span>
            </div>
        </div>
    `;
        }

        function renderMessages() {
            const c = conversations.find(x => x.id === selectedChat);
            if (!c) return;
            const msgs = messages[selectedChat] || [];
            document.getElementById('chatMessages').innerHTML = msgs.map(m => `
        <div class="message ${m.senderId === 'me' ? 'sent' : 'received'}">
            ${m.senderId !== 'me' ? `<img src="${c.avatar}" class="message-avatar" />` : ''}
            <div class="message-content">
                <div class="message-bubble">
                    <p>${m.text}</p>
                </div>
                <div class="message-meta">
                    <span class="message-time">${formatMessageTime(m.timestamp)}</span>
                    ${m.senderId === 'me' ? `<button class="delete-btn" onclick="deleteMessage(${m.id})">üóëÔ∏è</button>` : ''}
                </div>
            </div>
        </div>
    `).join('');
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function selectChat(id) {
            selectedChat = id;
            conversations = conversations.map(c => c.id === id ? { ...c, unread: 0 } : c);
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatWindow').classList.remove('hidden');
            renderConversations();
            renderChatHeader();
            renderMessages();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !selectedChat) return;
            const msg = {
                id: Date.now(),
                senderId: 'me',
                text: text,
                type: 'text',
                timestamp: new Date()
            };
            if (!messages[selectedChat]) messages[selectedChat] = [];
            messages[selectedChat].push(msg);
            conversations = conversations.map(c => c.id === selectedChat ? { ...c, lastMessage: text, timestamp: new Date() } : c);
            input.value = '';
            disappearingMode = null;
            updateDisappearingButtons();
            renderConversations();
            renderMessages();
        }

        function deleteMessage(id) {
            if (!selectedChat) return;
            messages[selectedChat] = messages[selectedChat].filter(m => m.id !== id);
            renderMessages();
        }

        function toggleDisappearingOptions() {
            document.getElementById('disappearingOptions').classList.toggle('hidden');
        }

        function setDisappearingMode(mode) {
            disappearingMode = disappearingMode === mode ? null : mode;
            updateDisappearingButtons();
        }

        function updateDisappearingButtons() {
            document.getElementById('readOnceBtn').classList.toggle('active', disappearingMode === 'read-once');
            document.getElementById('timedBtn').classList.toggle('active', disappearingMode === 'timed');
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    const msg = {
                        id: Date.now(),
                        senderId: 'me',
                        text: 'Voice message',
                        type: 'voice',
                        audioUrl: url,
                        timestamp: new Date()
                    };
                    if (!messages[selectedChat]) messages[selectedChat] = [];
                    messages[selectedChat].push(msg);
                    conversations = conversations.map(c => c.id === selectedChat ? { ...c, lastMessage: 'Voice message', timestamp: new Date() } : c);
                    stream.getTracks().forEach(t => t.stop());
                    renderConversations();
                    renderMessages();
                };
                mediaRecorder.start();
                isRecording = true;
                updateRecordingUI();
            } catch (err) {
                alert('Please allow microphone access.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                updateRecordingUI();
            }
        }

        function updateRecordingUI() {
            document.getElementById('normalInput').classList.toggle('hidden', isRecording);
            document.getElementById('recordingIndicator').classList.toggle('hidden', !isRecording);
            document.getElementById('micBtn').classList.toggle('hidden', isRecording);
            document.getElementById('stopBtn').classList.toggle('hidden', !isRecording);
        }

        // Story Interactions Helpers
        function toggleLike(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story) {
                story.liked = !story.liked;
                story.likes = (story.likes || 0) + (story.liked ? 1 : -1);

                // Update UI
                const activeCard = document.querySelector(`.story-card.active`);
                if (activeCard) {
                    const likeBtn = activeCard.querySelector('.story-like-btn');
                    if (likeBtn) {
                        likeBtn.classList.toggle('liked', story.liked);
                        likeBtn.querySelector('i').className = story.liked ? 'fas fa-heart' : 'far fa-heart';
                    }
                }
            }
        }

        function sendStoryReply(storyId, text) {
            if (!text.trim()) return;

            const story = stories.find(s => s.id === storyId);
            if (!story) return;

            const userId = story.userId;

            // Create new message
            const msg = {
                id: Date.now(),
                senderId: 'me',
                text: `Replied to story: ${text}`,
                storyRef: storyId,
                storyTitle: story.subject,
                type: 'text',
                timestamp: new Date()
            };

            if (!messages[userId]) messages[userId] = [];
            messages[userId].push(msg);

            // Update conversation list
            let conv = conversations.find(c => c.userId == userId);
            if (conv) {
                conv.lastMessage = `Replied to story: ${text}`;
                conv.timestamp = new Date();
                conv.unread = 0;
            } else {
                conversations.unshift({
                    id: userId,
                    userId: userId,
                    userName: story.userName,
                    avatar: story.avatar,
                    lastMessage: `Replied to story: ${text}`,
                    timestamp: new Date(),
                    unread: 0,
                    online: true
                });
            }

            closeStory();
            selectChat(userId);
        }

        function togglePreview() {
            const btn = document.getElementById('previewBtn');
            if (!btn) return;

            if (isPreviewPlaying) {
                stopPreview();
            } else {
                const start = parseInt(document.getElementById('startTimeInput').value) || 0;
                const end = parseInt(document.getElementById('endTimeInput').value) || 30;

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                btn.classList.add('playing');

                if (!previewPlayer) {
                    previewPlayer = new YT.Player('preview-player-container', {
                        height: '0',
                        width: '0',
                        videoId: selectedVideoForTimeRange.id,
                        playerVars: {
                            autoplay: 1,
                            controls: 0,
                            start: start,
                            end: end
                        },
                        events: {
                            onReady: (e) => {
                                e.target.playVideo();
                                btn.innerHTML = '<i class="fas fa-stop"></i> Stop Preview';
                                isPreviewPlaying = true;
                            },
                            onStateChange: (e) => {
                                if (e.data === YT.PlayerState.ENDED) {
                                    stopPreview();
                                }
                            }
                        }
                    });
                } else {
                    previewPlayer.loadVideoById({
                        videoId: selectedVideoForTimeRange.id,
                        startSeconds: start,
                        endSeconds: end
                    });
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Preview';
                    isPreviewPlaying = true;
                }
            }
        }

        function stopPreview() {
            isPreviewPlaying = false;
            const btn = document.getElementById('previewBtn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-play"></i> Play Preview';
                btn.classList.remove('playing');
            }

            if (previewPlayer) {
                previewPlayer.destroy();
                previewPlayer = null;
                const container = document.createElement('div');
                container.id = 'preview-player-container';
                container.style.display = 'none';
                const modalContent = document.querySelector('.time-range-selector');
                if (modalContent) modalContent.appendChild(container); // Re-append if context exists
            }
        }

        // Event Listeners
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', (e) => {
            document.getElementById('sendBtn').classList.toggle('hidden', !e.target.value.trim());
        });

        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('disappearingBtn').addEventListener('click', toggleDisappearingOptions);
        document.getElementById('readOnceBtn').addEventListener('click', () => setDisappearingMode('read-once'));
        document.getElementById('timedBtn').addEventListener('click', () => setDisappearingMode('timed'));
        document.getElementById('micBtn').addEventListener('click', startRecording);
        document.getElementById('stopBtn').addEventListener('click', stopRecording);

        document.getElementById('addStoryModal').addEventListener('click', (e) => {
            if (e.target.id === 'addStoryModal') closeAddStoryModal();
        });

        document.getElementById('storyModal').addEventListener('click', (e) => {
            if (e.target.id === 'storyModal') closeStory();
        });

        document.addEventListener('keydown', handleKeyPress);

        document.addEventListener('DOMContentLoaded', () => {
            setupLiveYouTubeSearch();
            renderStories();
            renderConversations();
        });
        // Add this function to initialize comment box in the modal

        function addCommentBoxToModal() {
            const modal = document.getElementById('storyModal');
            if (modal && !document.getElementById('commentBox')) {
                const commentBox = document.createElement('div');
                commentBox.id = 'commentBox';
                commentBox.className = 'story-comment-box';

                // Add click handler to prevent propagation on the box itself
                commentBox.addEventListener('click', function (e) {
                    e.stopPropagation();
                });

                commentBox.innerHTML = `
            <div class="comment-box-header">
                <h4><i class="fas fa-comments"></i> Comments</h4>
                <button class="comment-box-close" onclick="closeCommentBox(event)">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="comment-box-content" id="commentBoxContent">
                <!-- Comments will be loaded here -->
            </div>
            <div class="comment-box-input-wrapper">
                <input type="text" class="comment-box-input" id="commentBoxInput" 
                       placeholder="Add a comment..." 
                       onkeydown="if(event.key === 'Enter') { event.stopPropagation(); submitComment(event); }"
                       onclick="event.stopPropagation()">
                <button class="comment-box-send-btn" onclick="submitComment(event)">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
                modal.appendChild(commentBox);
            }
        }
        let currentCommentStoryId = null;

        function toggleCommentBox(storyId, event) {
            // Prevent event from bubbling up
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const commentBox = document.getElementById('commentBox');
            if (!commentBox) {
                addCommentBoxToModal();
            }

            const box = document.getElementById('commentBox');
            currentCommentStoryId = storyId;

            if (box.classList.contains('active') && currentCommentStoryId === storyId) {
                closeCommentBox();
            } else {
                loadComments(storyId);
                box.classList.add('active');
            }
        }

        function closeCommentBox(event) {
            // Prevent event propagation
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const commentBox = document.getElementById('commentBox');
            if (commentBox) {
                commentBox.classList.remove('active');
            }
            currentCommentStoryId = null;
        }

        function loadComments(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;

            if (!story.comments) story.comments = [];

            const content = document.getElementById('commentBoxContent');
            if (!content) return;

            if (story.comments.length === 0) {
                content.innerHTML = '<div class="no-comments"><i class="fas fa-comment-slash"></i><p>No comments yet. Be the first!</p></div>';
            } else {
                content.innerHTML = story.comments.map(comment => `
            <div class="comment-item">
                <img src="${comment.avatar}" class="comment-avatar" alt="${comment.userName}">
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-username">${comment.userName}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                </div>
            </div>
        `).join('');
            }

            // Scroll to bottom
            content.scrollTop = content.scrollHeight;
        }

        // ============================================
        // 6. UPDATE submitComment FUNCTION
        // ============================================
        // Replace submitComment to prevent propagation:

        function submitComment(event) {
            // Prevent event propagation
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const input = document.getElementById('commentBoxInput');
            if (!input) return;

            const text = input.value.trim();
            if (!text || !currentCommentStoryId) return;

            const story = stories.find(s => s.id === currentCommentStoryId);
            if (!story) return;

            if (!story.comments) story.comments = [];

            const comment = {
                id: Date.now(),
                userId: 'me',
                userName: 'You',
                avatar: 'https://i.pravatar.cc/150?img=11',
                text: text,
                timestamp: new Date()
            };

            story.comments.push(comment);
            stories = stories.map(s => s.id === currentCommentStoryId ? story : s);

            input.value = '';
            loadComments(currentCommentStoryId);
        }
    </script>
</body>

</html>
